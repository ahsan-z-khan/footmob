{% extends "base.html" %}

{% block title %}{{ group.name }} - FootMob{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 lg:py-8">
    <!-- Page Header -->
    <div class="mb-6 lg:mb-8">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
            <div class="flex items-center space-x-3 lg:space-x-4">
                <div class="h-12 w-12 lg:h-16 lg:w-16 bg-gray-100 rounded-lg flex items-center justify-center text-2xl lg:text-3xl">
                    {{ group.emoji }}
                </div>
                <div>
                    <h1 class="text-2xl lg:text-3xl font-bold text-gray-900 truncate max-w-[250px] sm:max-w-none">{{ group.name }}</h1>
                    <div class="flex items-center mt-1 lg:mt-2">
                        <span class="text-sm text-gray-600 font-normal">
                            {{ members|length }} member{{ 's' if members|length != 1 else '' }}
                        </span>
                        <span class="mx-2 text-gray-300">•</span>
                        <span class="text-sm text-gray-600 font-normal">
                            {% if membership.is_admin %}
                            <span class="text-blue-600 font-semibold">You're an admin</span>
                            {% else %}
                            Member
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            
            {% if membership.is_admin %}
            <div class="flex flex-row gap-2 lg:gap-3 lg:mt-0">
                <a href="{{ url_for('invites.manage_invite', group_id=group.id) }}" class="inline-flex items-center px-3 lg:px-4 py-2 border border-gray-300 text-xs lg:text-sm font-semibold rounded-md text-gray-700 bg-white hover:bg-gray-50 flex-1 justify-center lg:flex-none">
                    <i class="fas fa-user-plus mr-1 lg:mr-2"></i>
                    <span class="hidden sm:inline">Invite Members</span>
                    <span class="sm:hidden">Invite</span>
                </a>
                <a href="{{ url_for('games.create', group_id=group.id) }}" class="inline-flex items-center px-3 lg:px-4 py-2 border border-transparent text-xs lg:text-sm font-semibold rounded-md text-white bg-blue-600 hover:bg-blue-700 flex-1 justify-center lg:flex-none">
                    <i class="fas fa-plus mr-1 lg:mr-2"></i>
                    <span class="hidden sm:inline">Create Game</span>
                    <span class="sm:hidden">Game</span>
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Navigation Tabs - Modern Design -->
    <div class="bg-white rounded-xl border border-gray-200 mb-4 lg:mb-6 overflow-hidden shadow-sm">
        <!-- Mobile Tab Selector -->
        <div class="lg:hidden bg-gray-50 border-b border-gray-200 p-4">
            <select id="mobile-tab-selector" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="overview" selected>Overview</option>
                <option value="games">Games & History</option>
                <option value="members">Members ({{ members|length }})</option>
                <option value="leaderboard">Leaderboard</option>
                <option value="stats">Statistics</option>
                {% if membership.is_admin %}
                <option value="attributes">Player Attributes</option>
                {% endif %}
            </select>
        </div>
        
        <!-- Desktop Tab Navigation -->
        <div class="hidden lg:block bg-gray-50 px-6 py-3">
            <nav class="flex space-x-1" aria-label="Tabs">
                <button onclick="showTab('overview')" id="overview-tab" class="tab-button relative px-4 py-2.5 text-sm font-semibold rounded-lg transition-all duration-200 bg-blue-600 text-white shadow-sm">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-home text-sm"></i>
                        <span>Overview</span>
                    </div>
                </button>
                <button onclick="showTab('games')" id="games-tab" class="tab-button relative px-4 py-2.5 text-sm font-semibold rounded-lg transition-all duration-200 text-gray-600 hover:text-gray-900 hover:bg-white hover:shadow-sm">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-futbol text-sm"></i>
                        <span>Games & History</span>
                    </div>
                </button>
                <button onclick="showTab('members')" id="members-tab" class="tab-button relative px-4 py-2.5 text-sm font-semibold rounded-lg transition-all duration-200 text-gray-600 hover:text-gray-900 hover:bg-white hover:shadow-sm">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-users text-sm"></i>
                        <span>Members</span>
                        <span class="ml-1 px-2 py-0.5 bg-gray-200 text-gray-700 text-xs rounded-full">{{ members|length }}</span>
                    </div>
                </button>
                <button onclick="showTab('leaderboard')" id="leaderboard-tab" class="tab-button relative px-4 py-2.5 text-sm font-semibold rounded-lg transition-all duration-200 text-gray-600 hover:text-gray-900 hover:bg-white hover:shadow-sm">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-trophy text-sm"></i>
                        <span>Leaderboard</span>
                    </div>
                </button>
                <button onclick="showTab('stats')" id="stats-tab" class="tab-button relative px-4 py-2.5 text-sm font-semibold rounded-lg transition-all duration-200 text-gray-600 hover:text-gray-900 hover:bg-white hover:shadow-sm">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-chart-bar text-sm"></i>
                        <span>Statistics</span>
                    </div>
                </button>
                {% if membership.is_admin %}
                <button onclick="showTab('attributes')" id="attributes-tab" class="tab-button relative px-4 py-2.5 text-sm font-semibold rounded-lg transition-all duration-200 text-gray-600 hover:text-gray-900 hover:bg-white hover:shadow-sm">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-sliders-h text-sm"></i>
                        <span>Attributes</span>
                        <span class="ml-1 px-1.5 py-0.5 bg-blue-100 text-blue-800 text-xs rounded-full font-medium">ADMIN</span>
                    </div>
                </button>
                {% endif %}
            </nav>
        </div>
        
        <!-- Tab Content Container -->
        <div class="p-6">
            <!-- Tab Content -->
            <div id="overview-content" class="tab-content">
                <!-- Next Game Card -->
                {% if next_game %}
                <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6 shadow-sm hover:shadow-md transition-shadow duration-200">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-start space-x-4">
                            <div class="h-12 w-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar text-blue-600 text-lg"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900 mb-1">Next Game</h3>
                                <p class="text-sm text-gray-700 font-medium">{{ next_game.datetime.strftime('%A, %B %d at %I:%M %p') }}</p>
                                {% if next_game.location %}
                                    <p class="text-xs text-gray-600 flex items-center mt-2">
                                        <i class="fas fa-map-marker-alt mr-1 text-gray-400"></i>
                                        {{ next_game.location }}
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700 border border-blue-200">{{ next_game.status.title() }}</span>
                    </div>
                    
                    {% if next_game.notes %}
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-100">
                        <p class="text-xs text-gray-600">{{ next_game.notes }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="flex flex-wrap gap-3">
                        <a href="{{ url_for('games.view', game_id=next_game.id) }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                            <i class="fas fa-eye mr-2"></i>
                            View Details
                        </a>
                        <button onclick="shareGameInvite('{{ next_game.id }}', '{{ next_game.datetime.strftime('%A, %B %d at %I:%M %p') }}', '{{ group.name }}')" class="inline-flex items-center px-4 py-2 border border-blue-300 text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100">
                            <i class="fas fa-share-alt mr-2"></i>
                            Share Game
                        </button>
                    </div>
                </div>
                {% endif %}

                <!-- Last Result -->
                {% if last_game and last_game.status == 'finished' %}
                <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
                    <div class="flex items-start space-x-3 mb-4">
                        <div class="h-12 w-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-trophy text-green-600"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Last Result</h3>
                            <p class="text-xs text-gray-500 mt-1">{{ last_game.datetime.strftime('%B %d, %Y') }}</p>
                        </div>
                    </div>
                    {% set score = last_game.get_score() %}
                    <div class="bg-white rounded-lg p-4 border border-gray-100 mb-4 shadow-sm">
                        <div class="grid grid-cols-5 items-center text-center">
                            <div class="col-span-2">
                                <div class="text-sm font-semibold text-gray-700">Team A</div>
                            </div>
                            <div class="col-span-1">
                                <div class="text-3xl font-bold text-gray-900 font-mono">
                                    <span class="text-blue-600">{{ score.team_a }}</span>
                                    <span class="text-gray-300 mx-1">:</span>
                                    <span class="text-red-600">{{ score.team_b }}</span>
                                </div>
                            </div>
                            <div class="col-span-2">
                                <div class="text-sm font-semibold text-gray-700">Team B</div>
                            </div>
                        </div>
                    </div>
                    <a href="{{ url_for('games.view', game_id=last_game.id) }}" class="inline-flex items-center px-3 py-2 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-eye mr-1"></i>
                        View Details
                    </a>
                </div>
                {% endif %}

                <!-- Recent Activity -->
                {% if feed_items %}
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="h-12 w-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-pulse text-orange-600"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
                                <p class="text-xs text-gray-500">Latest group updates and events</p>
                            </div>
                        </div>
                        <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full">Live</span>
                    </div>
                    
                    <div class="flow-root">
                        <ul class="-mb-8">
                            {% for item in feed_items[:5] %}
                            <li>
                                <div class="relative pb-8">
                                    {% if not loop.last %}
                                    <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
                                    {% endif %}
                                    <div class="relative flex space-x-3">
                                        <!-- Activity Icon -->
                                        <div>
                                            <span class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center ring-8 ring-white">
                                                {% if 'joined' in item.content.lower() %}
                                                    <i class="fas fa-user-plus text-blue-600 text-xs"></i>
                                                {% elif 'game' in item.content.lower() %}
                                                    <i class="fas fa-futbol text-blue-600 text-xs"></i>
                                                {% elif 'goal' in item.content.lower() %}
                                                    <i class="fas fa-trophy text-blue-600 text-xs"></i>
                                                {% else %}
                                                    <i class="fas fa-circle text-blue-600 text-xs"></i>
                                                {% endif %}
                                            </span>
                                        </div>
                                        <!-- Activity Content -->
                                        <div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4">
                                            <div>
                                                <p class="text-sm text-gray-900 font-medium">{{ item.content }}</p>
                                            </div>
                                            <div class="text-right text-xs whitespace-nowrap text-gray-500">
                                                <time datetime="{{ item.created_at.isoformat() }}">
                                                    {{ item.created_at.strftime('%b %d') }}
                                                </time>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                    <!-- View All Activity Link -->
                    <div class="mt-6 pt-4 border-t border-gray-100">
                        <a href="{{ url_for('groups.activity', group_id=group.id) }}" class="block w-full text-center text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors">
                            View All Activity
                            <i class="fas fa-arrow-right ml-1 text-xs"></i>
                        </a>
                    </div>
                </div>
                {% endif %}
    </div>

    <!-- Games & History Tab -->
    <div id="games-content" class="tab-content hidden">
        <div class="space-y-6">
            <!-- Header Section -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="flex items-center space-x-4">
                    <div class="h-12 w-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar text-blue-600 text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-900">Match Center</h3>
                        <p class="text-sm text-gray-600">Upcoming games and match history</p>
                    </div>
                </div>
                {% if membership.is_admin %}
                <a href="{{ url_for('games.create', group_id=group.id) }}" class="inline-flex items-center px-4 py-2.5 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition-colors duration-200">
                    <i class="fas fa-plus mr-2"></i>
                    <span class="hidden sm:inline">Schedule New Game</span>
                    <span class="sm:hidden">New Game</span>
                </a>
                {% endif %}
            </div>
            
            {% if all_games %}
                <!-- Games Grid -->
                <div class="space-y-3">
                    {% for game in all_games %}
                        {% if game.status == 'upcoming' %}
                            {% set status_text = 'Upcoming' %}
                            {% set badge_color = 'bg-blue-50 text-blue-700 border-blue-200' %}
                        {% elif game.status == 'finished' %}
                            {% set status_text = 'Finished' %}
                            {% set badge_color = 'bg-green-50 text-green-700 border-green-200' %}
                        {% else %}
                            {% set status_text = 'In Progress' %}
                            {% set badge_color = 'bg-yellow-50 text-yellow-700 border-yellow-200' %}
                        {% endif %}
                        
                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow duration-200">
                            <!-- Game Info Row -->
                            <div class="flex items-center justify-between">
                                <!-- Left Section: Date, Time, Location -->
                                <div class="flex items-center space-x-3">
                                    <div class="flex-shrink-0">
                                        <div class="text-center">
                                            <div class="text-lg font-bold text-gray-900">{{ game.datetime.strftime('%d') }}</div>
                                            <div class="text-xs text-gray-500 uppercase">{{ game.datetime.strftime('%b') }}</div>
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <h4 class="text-base font-semibold text-gray-900 truncate">{{ game.datetime.strftime('%A') }}</h4>
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border {{ badge_color }}">
                                                {{ status_text }}
                                            </span>
                                        </div>
                                        <div class="flex items-center space-x-4 text-sm text-gray-600">
                                            <span class="flex items-center">
                                                <i class="fas fa-clock mr-1 text-xs"></i>
                                                {{ game.datetime.strftime('%I:%M %p') }}
                                            </span>
                                            {% if game.location %}
                                            <span class="flex items-center truncate">
                                                <i class="fas fa-map-marker-alt mr-1 text-xs"></i>
                                                {{ game.location }}
                                            </span>
                                            {% endif %}
                                        </div>
                                        {% if game.notes %}
                                        <p class="text-xs text-gray-500 italic mt-1 truncate">{{ game.notes }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Right Section: Score/Stats and Actions -->
                                <div class="flex items-center space-x-4">
                                    {% if game.status == 'finished' %}
                                        {% set score = game.get_score() %}
                                        <!-- Final Score -->
                                        <div class="text-center">
                                            <div class="text-xs text-gray-500 mb-1">Final Score</div>
                                            <div class="flex items-center space-x-2">
                                                <div class="text-center">
                                                    <div class="text-lg font-bold text-blue-600">{{ score.team_a }}</div>
                                                    <div class="text-xs text-gray-500">Blue</div>
                                                </div>
                                                <div class="text-gray-400">-</div>
                                                <div class="text-center">
                                                    <div class="text-lg font-bold text-red-600">{{ score.team_b }}</div>
                                                    <div class="text-xs text-gray-500">Red</div>
                                                </div>
                                            </div>
                                        </div>
                                    {% elif game.status == 'upcoming' %}
                                        {% set responses = game.get_responses() %}
                                        <!-- RSVP Stats -->
                                        <div class="text-center">
                                            <div class="text-xs text-gray-500 mb-1">RSVPs</div>
                                            <div class="flex items-center space-x-3 text-xs">
                                                <span class="text-green-600 font-medium">{{ responses.attending|length }} yes</span>
                                                <span class="text-red-600 font-medium">{{ responses.not_attending|length }} no</span>
                                                <span class="text-gray-500 font-medium">{{ responses.pending|length }} pending</span>
                                            </div>
                                            {% if game.is_poll_locked() %}
                                            <div class="mt-1">
                                                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-amber-50 text-amber-700 border border-amber-200">
                                                    <i class="fas fa-lock mr-1"></i>
                                                    Locked
                                                </span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Action Button -->
                                    <a href="{{ url_for('games.view', game_id=game.id) }}" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-blue-600 hover:text-blue-800 border border-blue-200 rounded hover:bg-blue-50 transition-colors duration-200">
                                        View
                                        <i class="fas fa-arrow-right ml-1 text-xs"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- Empty State -->
                <div class="bg-gray-50 rounded-lg border border-gray-200 p-12 text-center">
                    <div class="max-w-md mx-auto">
                        <div class="h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-calendar-plus text-2xl text-blue-600"></i>
                        </div>
                        <h4 class="text-xl font-semibold text-gray-900 mb-3">No Games Yet</h4>
                        <p class="text-gray-600 mb-8">Get your group started by scheduling your first match. Build team spirit and track your progress!</p>
                        {% if membership.is_admin %}
                        <a href="{{ url_for('games.create', group_id=group.id) }}" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors duration-200">
                            <i class="fas fa-plus mr-2"></i>
                            Schedule First Game
                        </a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Members Tab -->
    <div id="members-content" class="tab-content hidden">
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <div class="h-12 w-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-users text-purple-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-gray-900">All Members</h3>
                        <p class="text-xs text-gray-500 font-medium">{{ members|length }} total member{{ 's' if members|length != 1 else '' }}</p>
                    </div>
                </div>
                {% if membership.is_admin %}
                <div class="flex space-x-3">
                    <a href="{{ url_for('invites.manage_invite', group_id=group.id) }}" class="inline-flex items-center px-3 py-2 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-user-plus mr-1"></i>
                        Invite Members
                    </a>
                    <a href="{{ url_for('groups.members', group_id=group.id) }}" class="inline-flex items-center px-3 py-2 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-cog mr-1"></i>
                        Manage
                    </a>
                </div>
                {% endif %}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for member in members %}
                {% set member_membership = member.memberships|selectattr('group_id', 'equalto', group.id)|first %}
                <div class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                    <div class="flex items-center space-x-3">
                        <div class="relative inline-block h-10 w-10">
                            <img 
                                class="h-10 w-10 rounded-full object-cover border-2 border-indigo-200 shadow-sm" 
                                src="#" 
                                data-user-id="{{ member.id }}"
                                data-user-name="{{ member.display_name }}"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                            />
                            <div class="h-10 w-10 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-full flex items-center justify-center border-2 border-indigo-200 shadow-sm" style="display: none;">
                                <span class="text-sm font-bold text-white">
                                    {{ member.display_name[0].upper() }}
                                </span>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-bold text-gray-900 truncate">{{ member.display_name }}</h4>
                            <div class="flex items-center space-x-2 mt-1">
                                {% if member_membership.is_admin %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-crown mr-1"></i>
                                    Admin
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-800">
                                    Member
                                </span>
                                {% endif %}
                            </div>
                            <p class="text-xs text-gray-500 mt-1 font-medium">Joined {{ member_membership.joined_at.strftime('%b %Y') }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Leaderboard Tab -->
    <div id="leaderboard-content" class="tab-content hidden">
        <div class="bg-white rounded-lg border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="h-12 w-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-trophy text-yellow-600"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-black text-gray-900">Group Leaderboard</h3>
                            <p class="text-sm text-gray-500 font-medium">Player rankings based on match performance</p>
                        </div>
                    </div>
                    <div class="hidden sm:flex text-sm text-gray-600 bg-gray-50 px-3 py-1 rounded-lg">
                        <i class="fas fa-info-circle mr-1"></i>
                        Win: 3pts • Draw: 1pt • Loss: 0pts
                    </div>
                    <div class="sm:hidden text-xs text-gray-600 bg-gray-50 px-2 py-1 rounded">
                        <i class="fas fa-info-circle mr-1"></i>
                        3/1/0 pts
                    </div>
                </div>
            </div>

            {% if leaderboard_data %}
            <div class="overflow-x-auto">
                <table id="leaderboard-table" class="w-full min-w-max">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="sortable px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="rank">
                                <div class="flex items-center space-x-1">
                                    <span>Rank</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="player">
                                <div class="flex items-center space-x-1">
                                    <span>Player</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="points">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>Pts</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="games">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>GP</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="wins">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>W</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable hidden sm:table-cell px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="draws">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>D</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable hidden sm:table-cell px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="losses">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>L</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="goals">
                                <div class="flex items-center justify-center space-x-1">
                                    <span class="hidden sm:inline">Goals</span>
                                    <span class="sm:hidden">G</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable hidden md:table-cell px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="assists">
                                <div class="flex items-center justify-center space-x-1">
                                    <span class="hidden sm:inline">Assists</span>
                                    <span class="sm:hidden">A</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable hidden lg:table-cell px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="own_goals">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>OG</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable hidden lg:table-cell px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="potm">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>POTM</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable hidden md:table-cell px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="contributions">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>G+A</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-tbody" class="bg-white divide-y divide-gray-200">
                        {% for player in leaderboard_data %}
                        <tr class="leaderboard-row hover:bg-gray-50" data-player-data='{{ player | tojson }}'>
                            <td class="px-2 sm:px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    {% if loop.index == 1 %}
                                    <div class="flex items-center justify-center w-8 h-8 bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-full text-white font-bold text-sm">
                                        <i class="fas fa-crown"></i>
                                    </div>
                                    {% elif loop.index == 2 %}
                                    <div class="flex items-center justify-center w-8 h-8 bg-gradient-to-r from-gray-300 to-gray-400 rounded-full text-white font-bold text-sm">
                                        2
                                    </div>
                                    {% elif loop.index == 3 %}
                                    <div class="flex items-center justify-center w-8 h-8 bg-gradient-to-r from-orange-300 to-orange-400 rounded-full text-white font-bold text-sm">
                                        3
                                    </div>
                                    {% else %}
                                    <div class="flex items-center justify-center w-8 h-8 bg-gray-100 rounded-full text-gray-600 font-semibold text-sm">
                                        {{ loop.index }}
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-2 sm:px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="relative inline-block h-8 w-8 sm:h-10 sm:w-10 mr-2 sm:mr-3">
                                        <img 
                                            class="h-8 w-8 sm:h-10 sm:w-10 rounded-full object-cover border border-gray-200" 
                                            src="#" 
                                            data-user-id="{{ player.user_id }}"
                                            data-user-name="{{ player.display_name }}"
                                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                        />
                                        <div class="h-8 w-8 sm:h-10 sm:w-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center border border-gray-200" style="display: none;">
                                            <span class="text-xs sm:text-sm font-bold text-white">
                                                {{ player.display_name[0].upper() }}
                                            </span>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-xs sm:text-sm font-semibold text-gray-900 truncate max-w-24 sm:max-w-none">{{ player.display_name }}</div>
                                        {% if player.user_id == current_user.id %}
                                        <div class="text-xs text-blue-600 font-bold">You</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-center">
                                <div class="inline-flex items-center px-1.5 sm:px-2.5 py-0.5 rounded-full text-xs sm:text-sm font-medium bg-blue-100 text-blue-800">
                                    {{ player.points }}
                                </div>
                            </td>
                            <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900 text-center">{{ player.games_played }}</td>
                            <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-center">
                                <span class="inline-flex items-center px-1.5 sm:px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    {{ player.wins }}
                                </span>
                            </td>
                            <td class="hidden sm:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-center">
                                <span class="inline-flex items-center px-1.5 sm:px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    {{ player.draws }}
                                </span>
                            </td>
                            <td class="hidden sm:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-center">
                                <span class="inline-flex items-center px-1.5 sm:px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    {{ player.losses }}
                                </span>
                            </td>
                            <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900 text-center">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-futbol text-blue-500 mr-1 text-xs hidden sm:inline"></i>
                                    <span class="font-semibold">{{ player.goals }}</span>
                                </div>
                            </td>
                            <td class="hidden md:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900 text-center">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-hands-helping text-green-500 mr-1 text-xs hidden sm:inline"></i>
                                    <span class="font-semibold">{{ player.assists }}</span>
                                </div>
                            </td>
                            <td class="hidden lg:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900 text-center">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-orange-500 mr-1 text-xs hidden sm:inline"></i>
                                    <span class="font-semibold text-orange-700">{{ player.own_goals }}</span>
                                </div>
                            </td>
                            <td class="hidden lg:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900 text-center">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-star text-yellow-500 mr-1 text-xs hidden sm:inline"></i>
                                    <span class="font-semibold">{{ player.potm_awards }}</span>
                                </div>
                            </td>
                            <td class="hidden md:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-center">
                                <div class="inline-flex items-center px-1.5 sm:px-2.5 py-0.5 rounded-full text-xs sm:text-sm font-bold bg-purple-100 text-purple-800">
                                    {{ player.total_contributions }}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12">
                <div class="h-16 w-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-trophy text-yellow-600 text-xl"></i>
                </div>
                <h4 class="text-lg font-medium text-gray-900 mb-2">No match data yet</h4>
                <p class="text-sm text-gray-500 mb-4">The leaderboard will show player rankings after matches are completed</p>
                {% if membership.is_admin %}
                <a href="{{ url_for('games.create', group_id=group.id) }}" 
                   class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                    <i class="fas fa-plus mr-2"></i>
                    Create First Game
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Statistics Tab -->
    <div id="stats-content" class="tab-content hidden">
        <div class="space-y-6">
            <!-- Group Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-gamepad text-blue-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-2xl font-bold text-gray-900">{{ group_stats.total_games if group_stats else 0 }}</div>
                            <div class="text-sm text-gray-500 font-medium">Total Games</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-trophy text-green-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-2xl font-bold text-gray-900">{{ group_stats.total_goals if group_stats else 0 }}</div>
                            <div class="text-sm text-gray-500 font-medium">Goals Scored</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-percentage text-purple-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-2xl font-bold text-gray-900">{{ group_stats.attendance_rate if group_stats else 0 }}%</div>
                            <div class="text-sm text-gray-500 font-medium">Attendance Rate</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Players -->
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="h-12 w-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-star text-yellow-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-gray-900">Top Players</h3>
                        <p class="text-xs text-gray-500 font-medium">Based on goals and participation</p>
                    </div>
                </div>
                
                {% if group_stats and group_stats.total_games > 0 %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% if group_stats.top_scorer %}
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-4 border border-yellow-200">
                        <div class="flex items-center space-x-3">
                            <div class="h-10 w-10 bg-yellow-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-crown text-yellow-600"></i>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-gray-900">Top Scorer</div>
                                <div class="text-lg font-black text-yellow-800">{{ group_stats.top_scorer[0] }}</div>
                                <div class="text-xs text-gray-600 font-medium">{{ group_stats.top_scorer[1] }} goal{{ 's' if group_stats.top_scorer[1] != 1 else '' }}</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if group_stats.most_active_player %}
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200">
                        <div class="flex items-center space-x-3">
                            <div class="h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-medal text-blue-600"></i>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-gray-900">Most Active</div>
                                <div class="text-lg font-black text-blue-800">{{ group_stats.most_active_player[0] }}</div>
                                <div class="text-xs text-gray-600 font-medium">{{ group_stats.most_active_player[1] }} game{{ 's' if group_stats.most_active_player[1] != 1 else '' }}</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Additional Stats -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-sm font-bold text-gray-900 mb-3">Quick Stats</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-lg font-bold text-gray-900">{{ group_stats.average_goals_per_game }}</div>
                            <div class="text-xs text-gray-500 font-medium">Avg Goals/Game</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-gray-900">{{ group_stats.total_assists }}</div>
                            <div class="text-xs text-gray-500 font-medium">Total Assists</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-gray-900">{{ group_stats.upcoming_games }}</div>
                            <div class="text-xs text-gray-500 font-medium">Upcoming Games</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-gray-900">{{ group_stats.total_own_goals }}</div>
                            <div class="text-xs text-gray-500 font-medium">Own Goals</div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-chart-bar text-3xl mb-4"></i>
                    <p class="font-medium">Statistics will appear after games are played</p>
                    <p class="text-xs mt-2 font-medium">Goals, assists, and POTM awards will be tracked here</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Player Attributes Tab (Admin Only) -->
    {% if membership.is_admin %}
    <div id="attributes-content" class="tab-content hidden">
        <div class="space-y-4">
            <!-- Compact Header Section -->
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <div class="h-8 w-8 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-radar text-blue-600 text-sm"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">Player Attributes</h3>
                            <p class="text-xs text-gray-600">Manage skills & ratings</p>
                        </div>
                    </div>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-700">
                        <i class="fas fa-lock mr-1"></i>
                        Admin
                    </span>
                </div>

                <!-- Compact Search and Filter -->
                <div class="flex gap-3">
                    <div class="flex-1">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400 text-sm"></i>
                            </div>
                            <input type="text" id="player-search" class="block w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg bg-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Search players...">
                        </div>
                    </div>
                    <div class="w-32">
                        <select id="position-filter" class="block w-full px-2 py-2 border border-gray-300 rounded-lg bg-white text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All</option>
                            <option value="GK">GK</option>
                            <option value="DEF">DEF</option>
                            <option value="MID">MID</option>
                            <option value="FWD">FWD</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Compact Players List -->
            <div id="players-attributes-grid" class="space-y-2">
                {% for member in members %}
                {% set member_attributes = player_attributes.get(member.id) %}
                <div class="player-card bg-white border border-gray-200 rounded-lg p-3 hover:shadow-sm transition-all duration-200 hover:border-gray-300" 
                     data-player-id="{{ member.id }}" 
                     data-player-name="{{ member.display_name.lower() }}"
                     data-player-position="{{ member_attributes.preferred_position if member_attributes else '' }}">
                    
                    <div class="flex items-center space-x-3">
                        <!-- Compact Player Info -->
                        <div class="flex items-center space-x-3 flex-1">
                            <div class="relative">
                                <img src="#" alt="{{ member.display_name }}" class="h-10 w-10 rounded-full object-cover" 
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
                                     onload="loadAvatar(this, '{{ member.display_name }}', 40)">
                                <div class="h-10 w-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-semibold text-sm" style="display: none;">
                                    {{ member.display_name[0].upper() }}
                                </div>
                                {% if member_attributes %}
                                <div class="absolute -top-1 -right-1 h-4 w-4 bg-green-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-check text-white text-xs"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm font-semibold text-gray-900 truncate">{{ member.display_name }}</h4>
                                <div class="flex items-center space-x-2 mt-0.5">
                                    {% if member_attributes and member_attributes.preferred_position %}
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700">
                                        {% if member_attributes.preferred_position == 'GK' %}
                                            <i class="fas fa-hand-paper mr-1 text-yellow-600"></i>GK
                                        {% elif member_attributes.preferred_position == 'DEF' %}
                                            <i class="fas fa-shield-alt mr-1 text-red-600"></i>DEF
                                        {% elif member_attributes.preferred_position == 'MID' %}
                                            <i class="fas fa-cogs mr-1 text-blue-600"></i>MID
                                        {% elif member_attributes.preferred_position == 'FWD' %}
                                            <i class="fas fa-running mr-1 text-green-600"></i>FWD
                                        {% endif %}
                                    </span>
                                    {% endif %}
                                    {% if member_attributes %}
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-semibold bg-blue-100 text-blue-800">
                                        {{ member_attributes.get_overall_rating() }}/10
                                    </span>
                                    {% else %}
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-500">
                                        Not Rated
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Clear Attributes Display -->
                        {% if member_attributes %}
                        {% set categories = member_attributes.get_attribute_categories() %}
                        <div class="flex items-center space-x-4">
                            <!-- Key Attributes with Labels -->
                            <div class="flex items-center space-x-3 text-xs">
                                <div class="flex items-center space-x-1">
                                    <span class="text-gray-500">Physical:</span>
                                    <span class="font-semibold text-red-600">{{ "%.1f"|format((categories.physical.pace + categories.physical.stamina + categories.physical.strength + categories.physical.agility + categories.physical.jumping) / 5) }}</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <span class="text-gray-500">Tech:</span>
                                    <span class="font-semibold text-blue-600">{{ "%.1f"|format((categories.technical.ball_control + categories.technical.dribbling + categories.technical.passing + categories.technical.shooting + categories.technical.crossing + categories.technical.free_kicks) / 6) }}</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <span class="text-gray-500">Tactical:</span>
                                    <span class="font-semibold text-green-600">{{ "%.1f"|format((categories.tactical.positioning + categories.tactical.marking + categories.tactical.tackling + categories.tactical.interceptions + categories.tactical.vision + categories.tactical.decision_making) / 6) }}</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <span class="text-gray-500">Mental:</span>
                                    <span class="font-semibold text-purple-600">{{ "%.1f"|format((categories.mental.composure + categories.mental.concentration + categories.mental.determination + categories.mental.leadership + categories.mental.teamwork) / 5) }}</span>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-xs text-gray-400 flex items-center">
                            <i class="fas fa-chart-line mr-1"></i>
                            No attributes set
                        </div>
                        {% endif %}

                        <!-- Compact Action Button -->
                        <button onclick="editPlayerAttributes({{ member.id }}, '{{ member.display_name }}')" 
                                class="flex items-center justify-center px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                            <i class="fas fa-edit mr-1"></i>
                            {% if member_attributes %}Edit{% else %}Set{% endif %}
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- No players message -->
            {% if not members %}
            <div class="bg-white rounded-lg border border-gray-200 p-6 text-center">
                <div class="h-12 w-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-users text-blue-600"></i>
                </div>
                <h4 class="text-base font-semibold text-gray-900 mb-1">No members yet</h4>
                <p class="text-sm text-gray-600">Add members to start managing attributes.</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

<script>
function showTab(tabName) {
    // Hide all tab contents
    const contents = document.querySelectorAll('.tab-content');
    contents.forEach(content => content.classList.add('hidden'));
    
    // Show selected tab content
    const targetContent = document.getElementById(tabName + '-content');
    if (targetContent) {
        targetContent.classList.remove('hidden');
    }
    
    // Update desktop tab button styles
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(button => {
        // Remove active styles
        button.classList.remove('bg-blue-600', 'text-white', 'shadow-sm');
        // Add inactive styles
        button.classList.add('text-gray-600', 'hover:text-gray-900', 'hover:bg-white', 'hover:shadow-sm');
    });
    
    // Highlight active tab
    const activeButton = document.getElementById(tabName + '-tab');
    if (activeButton) {
        // Remove inactive styles
        activeButton.classList.remove('text-gray-600', 'hover:text-gray-900', 'hover:bg-white', 'hover:shadow-sm');
        // Add active styles
        activeButton.classList.add('bg-blue-600', 'text-white', 'shadow-sm');
    }
    
    // Update mobile selector
    const mobileSelector = document.getElementById('mobile-tab-selector');
    if (mobileSelector) {
        mobileSelector.value = tabName;
    }
}

// Handle mobile tab selector change
document.addEventListener('DOMContentLoaded', function() {
    const mobileSelector = document.getElementById('mobile-tab-selector');
    if (mobileSelector) {
        mobileSelector.addEventListener('change', function() {
            showTab(this.value);
        });
    }
});

// Initialize with appropriate tab based on URL hash or default to overview
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    const tabName = hash ? hash.substring(1) : 'overview';
    
    // Check if the tab exists, otherwise default to overview
    const validTabs = ['overview', 'games', 'members', 'leaderboard', 'stats', 'attributes'];
    const targetTab = validTabs.includes(tabName) ? tabName : 'overview';
    
    showTab(targetTab);
});

// Add click event listeners for tabs (backup in case onclick fails)
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.id.replace('-tab', '');
            showTab(tabName);
        });
    });
});

// Game invite sharing functionality
function shareGameInvite(gameId, gameTime, groupName) {
    // Create the shareable game URL
    const gameUrl = `${window.location.origin}/games/${gameId}`;
    const shareText = `🏈 Join us for football!\n\n${groupName}\n${gameTime}\n\nClick to vote on your availability:\n${gameUrl}`;
    
    // Check if the Web Share API is available
    if (navigator.share) {
        navigator.share({
            title: `${groupName} - Football Game`,
            text: shareText,
            url: gameUrl
        }).then(() => {
            console.log('Shared successfully');
        }).catch((error) => {
            console.log('Error sharing:', error);
            fallbackShare(shareText);
        });
    } else {
        fallbackShare(shareText);
    }
}

// Fallback sharing method
function fallbackShare(shareText) {
    // Try to copy to clipboard
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(shareText).then(() => {
            showToast('Game invite copied to clipboard!', 'success');
        }).catch(() => {
            showShareModal(shareText);
        });
    } else {
        showShareModal(shareText);
    }
}

// Show share modal with the text
function showShareModal(shareText) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
    modal.innerHTML = `
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Share Game Invite</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mt-2 px-4 py-3 bg-gray-50 rounded-lg">
                    <textarea id="shareText" class="w-full h-32 text-sm text-gray-700 bg-transparent border-none resize-none focus:outline-none" readonly>${shareText}</textarea>
                </div>
                <div class="items-center px-4 py-3">
                    <button onclick="copyShareText()" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700">
                        <i class="fas fa-copy mr-2"></i>Copy to Clipboard
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Copy share text function
function copyShareText() {
    const textArea = document.getElementById('shareText');
    textArea.select();
    document.execCommand('copy');
    showToast('Copied to clipboard!', 'success');
    document.querySelector('.fixed').remove();
}

// Toast notifications are now handled globally by base.html

// Leaderboard sorting functionality
let currentSortColumn = 'points';
let currentSortDirection = 'desc';

function initializeLeaderboardSorting() {
    const sortableHeaders = document.querySelectorAll('.sortable');
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.getAttribute('data-column');
            sortLeaderboard(column);
        });
    });
    
    // Set initial sort indicators
    updateSortIndicators();
}

function sortLeaderboard(column) {
    const tbody = document.getElementById('leaderboard-tbody');
    const rows = Array.from(tbody.querySelectorAll('.leaderboard-row'));
    
    // Determine sort direction
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = column;
        currentSortDirection = getDefaultSortDirection(column);
    }
    
    // Sort rows based on column and direction
    rows.sort((a, b) => {
        const aData = JSON.parse(a.getAttribute('data-player-data'));
        const bData = JSON.parse(b.getAttribute('data-player-data'));
        
        let aValue, bValue;
        
        switch(column) {
            case 'rank':
                aValue = getCurrentRank(a);
                bValue = getCurrentRank(b);
                break;
            case 'player':
                aValue = aData.display_name.toLowerCase();
                bValue = bData.display_name.toLowerCase();
                break;
            case 'points':
                aValue = aData.points;
                bValue = bData.points;
                break;
            case 'games':
                aValue = aData.games_played;
                bValue = bData.games_played;
                break;
            case 'wins':
                aValue = aData.wins;
                bValue = bData.wins;
                break;
            case 'draws':
                aValue = aData.draws;
                bValue = bData.draws;
                break;
            case 'losses':
                aValue = aData.losses;
                bValue = bData.losses;
                break;
            case 'goals':
                aValue = aData.goals;
                bValue = bData.goals;
                break;
            case 'assists':
                aValue = aData.assists;
                bValue = bData.assists;
                break;
            case 'own_goals':
                aValue = aData.own_goals;
                bValue = bData.own_goals;
                break;
            case 'potm':
                aValue = aData.potm_awards;
                bValue = bData.potm_awards;
                break;
            case 'contributions':
                aValue = aData.total_contributions;
                bValue = bData.total_contributions;
                break;
            default:
                return 0;
        }
        
        // Handle string vs number comparison
        if (typeof aValue === 'string') {
            return currentSortDirection === 'asc' ? 
                aValue.localeCompare(bValue) : 
                bValue.localeCompare(aValue);
        } else {
            return currentSortDirection === 'asc' ? 
                aValue - bValue : 
                bValue - aValue;
        }
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
    
    // Update rank numbers if sorting by rank
    if (column === 'rank') {
        updateRankNumbers();
    }
    
    // Update sort indicators
    updateSortIndicators();
}

function getCurrentRank(row) {
    const rankCell = row.querySelector('td:first-child div');
    const crownIcon = rankCell.querySelector('i.fa-crown');
    if (crownIcon) return 1;
    
    const rankText = rankCell.textContent.trim();
    return parseInt(rankText) || 999;
}

function getDefaultSortDirection(column) {
    // Most columns should sort high to low by default
    const ascendingColumns = ['player', 'rank', 'own_goals'];
    return ascendingColumns.includes(column) ? 'asc' : 'desc';
}

function updateSortIndicators() {
    // Reset all sort icons
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.className = 'fas fa-sort text-gray-400 sort-icon';
    });
    
    // Update active sort icon
    const activeHeader = document.querySelector(`[data-column="${currentSortColumn}"]`);
    if (activeHeader) {
        const sortIcon = activeHeader.querySelector('.sort-icon');
        if (currentSortDirection === 'asc') {
            sortIcon.className = 'fas fa-sort-up text-blue-600 sort-icon';
        } else {
            sortIcon.className = 'fas fa-sort-down text-blue-600 sort-icon';
        }
    }
}

function updateRankNumbers() {
    const tbody = document.getElementById('leaderboard-tbody');
    const rows = Array.from(tbody.querySelectorAll('.leaderboard-row'));
    
    rows.forEach((row, index) => {
        const rankCell = row.querySelector('td:first-child div');
        const rank = index + 1;
        
        // Update rank display
        if (rank === 1) {
            rankCell.innerHTML = '<i class="fas fa-crown"></i>';
            rankCell.className = 'flex items-center justify-center w-8 h-8 bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-full text-white font-bold text-sm';
        } else if (rank === 2) {
            rankCell.textContent = '2';
            rankCell.className = 'flex items-center justify-center w-8 h-8 bg-gradient-to-r from-gray-300 to-gray-400 rounded-full text-white font-bold text-sm';
        } else if (rank === 3) {
            rankCell.textContent = '3';
            rankCell.className = 'flex items-center justify-center w-8 h-8 bg-gradient-to-r from-orange-300 to-orange-400 rounded-full text-white font-bold text-sm';
        } else {
            rankCell.textContent = rank;
            rankCell.className = 'flex items-center justify-center w-8 h-8 bg-gray-100 rounded-full text-gray-600 font-semibold text-sm';
        }
    });
}

// Initialize leaderboard sorting when document is loaded
document.addEventListener('DOMContentLoaded', function() {
    showTab('overview');
    initializeLeaderboardSorting();
    initializePlayerAttributesSearch();
});

// Player Attributes Search and Filter functionality
function initializePlayerAttributesSearch() {
    const searchInput = document.getElementById('player-search');
    const positionFilter = document.getElementById('position-filter');
    
    if (searchInput) {
        searchInput.addEventListener('input', filterPlayers);
    }
    if (positionFilter) {
        positionFilter.addEventListener('change', filterPlayers);
    }
}

function filterPlayers() {
    const searchTerm = document.getElementById('player-search').value.toLowerCase();
    const positionFilter = document.getElementById('position-filter').value;
    const playerCards = document.querySelectorAll('.player-card');
    
    playerCards.forEach(card => {
        const playerName = card.getAttribute('data-player-name');
        const playerPosition = card.getAttribute('data-player-position');
        
        const matchesSearch = playerName.includes(searchTerm);
        const matchesPosition = !positionFilter || playerPosition === positionFilter;
        
        if (matchesSearch && matchesPosition) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// Edit Player Attributes Modal
function editPlayerAttributes(playerId, playerName) {
    const modalHtml = `
        <div id="attributes-modal" class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
            <div class="relative bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <!-- Header -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="h-10 w-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-chart-radar text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white">Player Attributes</h3>
                                <p class="text-blue-100 text-sm">${playerName}</p>
                            </div>
                        </div>
                        <button onclick="closeAttributesModal()" class="text-white hover:text-blue-200 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="overflow-y-auto max-h-[calc(90vh-80px)]">
                    <form id="attributes-form" class="p-6">
                        <input type="hidden" name="player_id" value="${playerId}">
                        
                        <!-- Position & Overall -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-map-marker-alt text-blue-600 mr-2"></i>
                                        Preferred Position
                                    </label>
                                    <select name="preferred_position" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Position</option>
                                        <option value="GK">🥅 Goalkeeper</option>
                                        <option value="DEF">🛡️ Defender</option>
                                        <option value="MID">⚙️ Midfielder</option>
                                        <option value="FWD">⚡ Forward</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-star text-yellow-500 mr-2"></i>
                                        Overall Rating
                                    </label>
                                    <div class="bg-white rounded-lg border border-gray-300 p-3">
                                        <div class="text-center">
                                            <span id="overall-rating" class="text-2xl font-bold text-blue-600">5.0</span>
                                            <span class="text-gray-500">/10</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Attributes Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <!-- Physical Attributes -->
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-red-800 mb-4 flex items-center">
                                    <i class="fas fa-dumbbell mr-2"></i>Physical
                                    <span id="physical-avg" class="ml-auto text-sm bg-red-100 px-2 py-1 rounded">0.0</span>
                                </h4>
                                <div class="space-y-4">
                                    ${createModernAttributeSlider('pace', 'Pace', '🏃‍♂️')}
                                    ${createModernAttributeSlider('stamina', 'Stamina', '💪')}
                                    ${createModernAttributeSlider('strength', 'Strength', '🏋️‍♂️')}
                                    ${createModernAttributeSlider('agility', 'Agility', '🤸‍♂️')}
                                    ${createModernAttributeSlider('jumping', 'Jumping', '⬆️')}
                                </div>
                            </div>

                            <!-- Technical Attributes -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                                    <i class="fas fa-futbol mr-2"></i>Technical
                                    <span id="technical-avg" class="ml-auto text-sm bg-blue-100 px-2 py-1 rounded">0.0</span>
                                </h4>
                                <div class="space-y-4">
                                    ${createModernAttributeSlider('ball_control', 'Ball Control', '⚽')}
                                    ${createModernAttributeSlider('dribbling', 'Dribbling', '🕺')}
                                    ${createModernAttributeSlider('passing', 'Passing', '🎯')}
                                    ${createModernAttributeSlider('shooting', 'Shooting', '🥅')}
                                    ${createModernAttributeSlider('crossing', 'Crossing', '📐')}
                                    ${createModernAttributeSlider('free_kicks', 'Free Kicks', '🎪')}
                                </div>
                            </div>

                            <!-- Tactical Attributes -->
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-green-800 mb-4 flex items-center">
                                    <i class="fas fa-chess mr-2"></i>Tactical
                                    <span id="tactical-avg" class="ml-auto text-sm bg-green-100 px-2 py-1 rounded">0.0</span>
                                </h4>
                                <div class="space-y-4">
                                    ${createModernAttributeSlider('positioning', 'Positioning', '📍')}
                                    ${createModernAttributeSlider('marking', 'Marking', '👥')}
                                    ${createModernAttributeSlider('tackling', 'Tackling', '🛑')}
                                    ${createModernAttributeSlider('interceptions', 'Interceptions', '🚫')}
                                    ${createModernAttributeSlider('vision', 'Vision', '👁️')}
                                    ${createModernAttributeSlider('decision_making', 'Decision Making', '🧠')}
                                </div>
                            </div>

                            <!-- Mental Attributes -->
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                                    <i class="fas fa-brain mr-2"></i>Mental
                                    <span id="mental-avg" class="ml-auto text-sm bg-purple-100 px-2 py-1 rounded">0.0</span>
                                </h4>
                                <div class="space-y-4">
                                    ${createModernAttributeSlider('composure', 'Composure', '😌')}
                                    ${createModernAttributeSlider('concentration', 'Concentration', '🎯')}
                                    ${createModernAttributeSlider('determination', 'Determination', '💪')}
                                    ${createModernAttributeSlider('leadership', 'Leadership', '👑')}
                                    ${createModernAttributeSlider('teamwork', 'Teamwork', '🤝')}
                                </div>
                            </div>
                        </div>

                        <!-- Goalkeeping Attributes (Hidden by default) -->
                        <div id="goalkeeping-section" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6" style="display: none;">
                            <h4 class="text-lg font-semibold text-yellow-800 mb-4 flex items-center">
                                <i class="fas fa-hand-paper mr-2"></i>Goalkeeping
                                <span id="goalkeeping-avg" class="ml-auto text-sm bg-yellow-100 px-2 py-1 rounded">0.0</span>
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${createModernAttributeSlider('goalkeeping', 'Goalkeeping', '🥅')}
                                ${createModernAttributeSlider('handling', 'Handling', '🧤')}
                                ${createModernAttributeSlider('distribution', 'Distribution', '🎯')}
                                ${createModernAttributeSlider('aerial_reach', 'Aerial Reach', '🦅')}
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-sticky-note mr-2 text-gray-600"></i>
                                Additional Notes
                            </label>
                            <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Any additional notes about the player's abilities, playing style, or areas for improvement..."></textarea>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                            <button type="button" onclick="closeAttributesModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors">
                                Cancel
                            </button>
                            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors">
                                <i class="fas fa-save mr-2"></i>Save Attributes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    initializeAttributesModal(playerId);
}

function createModernAttributeSlider(name, label, emoji) {
    return `
        <div class="space-y-2">
            <div class="flex items-center justify-between">
                <label class="text-sm font-medium text-gray-700 flex items-center">
                    <span class="mr-2">${emoji}</span>
                    ${label}
                </label>
                <div class="flex items-center space-x-2">
                    <span id="${name}-value" class="text-sm font-bold text-gray-900 min-w-[20px] text-center">5</span>
                    <div class="flex space-x-1">
                        ${Array.from({length: 10}, (_, i) => `<div class="w-2 h-2 rounded-full bg-gray-200 ${name}-dot" data-value="${i + 1}"></div>`).join('')}
                    </div>
                </div>
            </div>
            <input type="range" name="${name}" id="${name}-slider" min="1" max="10" value="5" 
                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                   oninput="updateModernSliderValue('${name}')">
        </div>
    `;
}

function updateModernSliderValue(attributeName) {
    const slider = document.getElementById(attributeName + '-slider');
    const valueDisplay = document.getElementById(attributeName + '-value');
    valueDisplay.textContent = slider.value;
    
    // Update dots visualization
    const dots = document.querySelectorAll(`.${attributeName}-dot`);
    dots.forEach((dot, index) => {
        if (index < slider.value) {
            dot.classList.remove('bg-gray-200');
            dot.classList.add('bg-blue-500');
        } else {
            dot.classList.remove('bg-blue-500');
            dot.classList.add('bg-gray-200');
        }
    });
    
    // Update category averages
    updateCategoryAverages();
}

function updateCategoryAverages() {
    const categories = {
        physical: ['pace', 'stamina', 'strength', 'agility', 'jumping'],
        technical: ['ball_control', 'dribbling', 'passing', 'shooting', 'crossing', 'free_kicks'],
        tactical: ['positioning', 'marking', 'tackling', 'interceptions', 'vision', 'decision_making'],
        mental: ['composure', 'concentration', 'determination', 'leadership', 'teamwork'],
        goalkeeping: ['goalkeeping', 'handling', 'distribution', 'aerial_reach']
    };
    
    Object.keys(categories).forEach(category => {
        const attributes = categories[category];
        let total = 0;
        let count = 0;
        
        attributes.forEach(attr => {
            const slider = document.getElementById(attr + '-slider');
            if (slider) {
                total += parseInt(slider.value);
                count++;
            }
        });
        
        if (count > 0) {
            const avg = (total / count).toFixed(1);
            const avgElement = document.getElementById(category + '-avg');
            if (avgElement) {
                avgElement.textContent = avg;
            }
        }
    });
    
    // Update overall rating
    const allSliders = document.querySelectorAll('#attributes-form input[type="range"]');
    let totalRating = 0;
    allSliders.forEach(slider => {
        totalRating += parseInt(slider.value);
    });
    const overallRating = (totalRating / allSliders.length).toFixed(1);
    const overallElement = document.getElementById('overall-rating');
    if (overallElement) {
        overallElement.textContent = overallRating;
    }
}

function initializeAttributesModal(playerId) {
    const form = document.getElementById('attributes-form');
    const positionSelect = form.querySelector('[name="preferred_position"]');
    const goalkeepingSection = document.getElementById('goalkeeping-section');
    
    // Show/hide goalkeeping section based on position
    positionSelect.addEventListener('change', function() {
        if (this.value === 'GK') {
            goalkeepingSection.style.display = 'block';
        } else {
            goalkeepingSection.style.display = 'none';
        }
    });
    
    // Load existing attributes if they exist
    loadPlayerAttributes(playerId);
    
    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        savePlayerAttributes();
    });
}

function loadPlayerAttributes(playerId) {
    fetch(`/groups/{{ group.id }}/players/${playerId}/attributes`)
        .then(response => response.json())
        .then(data => {
            if (data.attributes) {
                const form = document.getElementById('attributes-form');
                const attributes = data.attributes;
                
                // Set position
                if (attributes.preferred_position) {
                    form.querySelector('[name="preferred_position"]').value = attributes.preferred_position;
                    
                    // Show goalkeeping section if GK
                    if (attributes.preferred_position === 'GK') {
                        document.getElementById('goalkeeping-section').style.display = 'block';
                    }
                }
                
                // Set all attribute values
                const attributeNames = [
                    'pace', 'stamina', 'strength', 'agility', 'jumping',
                    'ball_control', 'dribbling', 'passing', 'shooting', 'crossing', 'free_kicks',
                    'positioning', 'marking', 'tackling', 'interceptions', 'vision', 'decision_making',
                    'composure', 'concentration', 'determination', 'leadership', 'teamwork',
                    'goalkeeping', 'handling', 'distribution', 'aerial_reach'
                ];
                
                attributeNames.forEach(attr => {
                    if (attributes[attr] !== undefined) {
                        const slider = document.getElementById(attr + '-slider');
                        const valueDisplay = document.getElementById(attr + '-value');
                        if (slider && valueDisplay) {
                            slider.value = attributes[attr];
                            valueDisplay.textContent = attributes[attr];
                        }
                    }
                });
                
                // Set notes
                if (attributes.notes) {
                    form.querySelector('[name="notes"]').value = attributes.notes;
                }
            }
        })
        .catch(error => {
            console.error('Error loading player attributes:', error);
        });
}

function savePlayerAttributes() {
    const form = document.getElementById('attributes-form');
    const formData = new FormData(form);
    const playerId = formData.get('player_id');
    
    fetch(`/groups/{{ group.id }}/players/${playerId}/attributes`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeAttributesModal();
            // Stay on the attributes tab and update the player's card
            showTab('attributes');
            // Update the specific player's card with new data
            const playerId = document.getElementById('attributes-form').querySelector('[name="player_id"]').value;
            updatePlayerCard(playerId);
        } else {
            showToast(data.error || 'Failed to update attributes', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving player attributes:', error);
        showToast('Error saving attributes', 'error');
    });
}

function updatePlayerCard(playerId) {
    // Fetch updated player data and re-render their card
    fetch(`/groups/{{ group.id }}/players/${playerId}/attributes`)
        .then(response => response.json())
        .then(data => {
            if (data.attributes) {
                // Find the player card element
                const playerCard = document.querySelector(`[data-player-id="${playerId}"]`);
                if (playerCard) {
                    // Update the card content with new attributes
                    updatePlayerCardDisplay(playerCard, data.attributes, data.player_name);
                    showToast('Player attributes updated successfully!', 'success');
                } else {
                    // Card not found, just show success message
                    showToast('Player attributes updated successfully!', 'success');
                }
            } else {
                showToast('Player attributes updated successfully!', 'success');
            }
        })
        .catch(error => {
            console.error('Error updating player card:', error);
            // Show success message since the save actually worked
            showToast('Player attributes updated successfully!', 'success');
        });
}

function updatePlayerCardDisplay(playerCard, attributes, playerName) {
    // Calculate category averages
    const categories = {
        physical: {
            pace: attributes.pace || 5,
            stamina: attributes.stamina || 5,
            strength: attributes.strength || 5,
            agility: attributes.agility || 5,
            jumping: attributes.jumping || 5
        },
        technical: {
            ball_control: attributes.ball_control || 5,
            dribbling: attributes.dribbling || 5,
            passing: attributes.passing || 5,
            shooting: attributes.shooting || 5,
            crossing: attributes.crossing || 5,
            free_kicks: attributes.free_kicks || 5
        },
        tactical: {
            positioning: attributes.positioning || 5,
            marking: attributes.marking || 5,
            tackling: attributes.tackling || 5,
            interceptions: attributes.interceptions || 5,
            vision: attributes.vision || 5,
            decision_making: attributes.decision_making || 5
        },
        mental: {
            composure: attributes.composure || 5,
            concentration: attributes.concentration || 5,
            determination: attributes.determination || 5,
            leadership: attributes.leadership || 5,
            teamwork: attributes.teamwork || 5
        }
    };

    // Add goalkeeping if position is GK
    if (attributes.preferred_position === 'GK') {
        categories.goalkeeping = {
            goalkeeping: attributes.goalkeeping || 1,
            handling: attributes.handling || 1,
            distribution: attributes.distribution || 1,
            aerial_reach: attributes.aerial_reach || 1
        };
    }

    // Calculate averages
    const categoryAverages = {};
    for (const [categoryName, categoryAttrs] of Object.entries(categories)) {
        const values = Object.values(categoryAttrs);
        categoryAverages[categoryName] = values.reduce((a, b) => a + b, 0) / values.length;
    }

    // Update the player card data attributes
    playerCard.setAttribute('data-player-position', attributes.preferred_position || '');
    
    // Find the position badge and update it
    const positionBadge = playerCard.querySelector('.bg-green-100');
    if (positionBadge && attributes.preferred_position) {
        let positionText = '';
        let icon = '';
        
        switch(attributes.preferred_position) {
            case 'GK':
                icon = 'fas fa-hand-paper';
                positionText = 'Goalkeeper';
                break;
            case 'DEF':
                icon = 'fas fa-shield-alt';
                positionText = 'Defender';
                break;
            case 'MID':
                icon = 'fas fa-cogs';
                positionText = 'Midfielder';
                break;
            case 'FWD':
                icon = 'fas fa-running';
                positionText = 'Forward';
                break;
        }
        
        positionBadge.innerHTML = `<i class="${icon} mr-1"></i>${positionText}`;
    }

    // Generate progress bars HTML
    function generateProgressBars(categoryAttrs, colorClass) {
        return Object.values(categoryAttrs).map(value => 
            `<div class="flex-1 bg-${colorClass}-200 rounded-full h-2">
                <div class="bg-${colorClass}-500 h-2 rounded-full" style="width: ${value * 10}%"></div>
            </div>`
        ).join('');
    }

    // Find the attributes container and update it
    const attributesContainer = playerCard.querySelector('.space-y-3');
    if (attributesContainer) {
        let newContent = '';
        
        // Physical attributes
        newContent += `
            <div class="bg-red-50 rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-red-700">
                        <i class="fas fa-running mr-1"></i>Physical
                    </span>
                    <span class="text-sm font-bold text-red-800">
                        ${categoryAverages.physical.toFixed(1)}
                    </span>
                </div>
                <div class="flex space-x-1">
                    ${generateProgressBars(categories.physical, 'red')}
                </div>
            </div>`;

        // Technical attributes
        newContent += `
            <div class="bg-blue-50 rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-blue-700">
                        <i class="fas fa-futbol mr-1"></i>Technical
                    </span>
                    <span class="text-sm font-bold text-blue-800">
                        ${categoryAverages.technical.toFixed(1)}
                    </span>
                </div>
                <div class="flex space-x-1">
                    ${generateProgressBars(categories.technical, 'blue')}
                </div>
            </div>`;

        // Tactical attributes
        newContent += `
            <div class="bg-green-50 rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-green-700">
                        <i class="fas fa-chess mr-1"></i>Tactical
                    </span>
                    <span class="text-sm font-bold text-green-800">
                        ${categoryAverages.tactical.toFixed(1)}
                    </span>
                </div>
                <div class="flex space-x-1">
                    ${generateProgressBars(categories.tactical, 'green')}
                </div>
            </div>`;

        // Mental attributes
        newContent += `
            <div class="bg-purple-50 rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-purple-700">
                        <i class="fas fa-brain mr-1"></i>Mental
                    </span>
                    <span class="text-sm font-bold text-purple-800">
                        ${categoryAverages.mental.toFixed(1)}
                    </span>
                </div>
                <div class="flex space-x-1">
                    ${generateProgressBars(categories.mental, 'purple')}
                </div>
            </div>`;

        // Goalkeeping attributes (if applicable)
        if (categories.goalkeeping) {
            newContent += `
                <div class="bg-yellow-50 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-yellow-700">
                            <i class="fas fa-hand-paper mr-1"></i>Goalkeeping
                        </span>
                        <span class="text-sm font-bold text-yellow-800">
                            ${categoryAverages.goalkeeping.toFixed(1)}
                        </span>
                    </div>
                    <div class="flex space-x-1">
                        ${generateProgressBars(categories.goalkeeping, 'yellow')}
                    </div>
                </div>`;
        }

        // Notes (if any)
        if (attributes.notes) {
            newContent += `
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-sticky-note mr-1 text-gray-400"></i>
                        ${attributes.notes}
                    </p>
                </div>`;
        }

        attributesContainer.innerHTML = newContent;
    }

    // Update the button text if needed
    const editButton = playerCard.querySelector('button');
    if (editButton) {
        editButton.innerHTML = '<i class="fas fa-edit mr-2"></i>Edit Attributes';
    }
}

function closeAttributesModal() {
    const modal = document.getElementById('attributes-modal');
    if (modal) {
        modal.remove();
    }
}
</script>
{% endblock %}