{% extends "base.html" %}

{% block title %}{{ group.name }} - FootMob{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="sm:flex sm:items-center sm:justify-between">
            <div class="flex items-center space-x-4">
                <div class="h-16 w-16 bg-gray-100 rounded-lg flex items-center justify-center text-3xl">
                    {{ group.emoji }}
                </div>
                <div>
                    <h1 class="text-3xl font-black text-gray-900">{{ group.name }}</h1>
                    <div class="flex items-center mt-2">
                        <span class="text-sm text-gray-600 font-medium">
                            {{ members|length }} member{{ 's' if members|length != 1 else '' }}
                        </span>
                        <span class="mx-2 text-gray-300">•</span>
                        <span class="text-sm text-gray-600 font-medium">
                            {% if membership.is_admin %}
                            <span class="text-blue-600 font-bold">You're an admin</span>
                            {% else %}
                            Member
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            
            {% if membership.is_admin %}
            <div class="mt-6 flex flex-col sm:flex-row gap-3 sm:mt-0">
                <a href="{{ url_for('invites.manage_invite', group_id=group.id) }}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-semibold rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fas fa-user-plus mr-2"></i>
                    <span class="hidden sm:inline">Invite Members</span>
                    <span class="sm:hidden">Invite</span>
                </a>
                <a href="{{ url_for('games.create', group_id=group.id) }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-semibold rounded-md text-white bg-blue-600 hover:bg-blue-700">
                    <i class="fas fa-plus mr-2"></i>
                    <span class="hidden sm:inline">Create Game</span>
                    <span class="sm:hidden">Game</span>
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="bg-white rounded-lg border border-gray-200 mb-6">
        <div class="border-b border-gray-200">
            <nav class="overflow-x-auto" aria-label="Tabs">
                <div class="flex space-x-1 sm:space-x-8 px-4 sm:px-6 min-w-max">
                    <button onclick="showTab('overview')" id="overview-tab" class="tab-button flex-shrink-0 py-4 px-2 sm:px-1 border-b-2 border-blue-500 text-blue-600 font-bold text-xs sm:text-sm whitespace-nowrap">
                        <span class="hidden sm:inline">Overview</span>
                        <span class="sm:hidden">Home</span>
                    </button>
                    <button onclick="showTab('games')" id="games-tab" class="tab-button flex-shrink-0 py-4 px-2 sm:px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-bold text-xs sm:text-sm whitespace-nowrap">
                        <span class="hidden sm:inline">Games & History</span>
                        <span class="sm:hidden">Games</span>
                    </button>
                    <button onclick="showTab('members')" id="members-tab" class="tab-button flex-shrink-0 py-4 px-2 sm:px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-bold text-xs sm:text-sm whitespace-nowrap">
                        <span class="hidden sm:inline">Members ({{ members|length }})</span>
                        <span class="sm:hidden">Members</span>
                    </button>
                    <button onclick="showTab('leaderboard')" id="leaderboard-tab" class="tab-button flex-shrink-0 py-4 px-2 sm:px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-bold text-xs sm:text-sm whitespace-nowrap">
                        <span class="hidden sm:inline">Leaderboard</span>
                        <span class="sm:hidden">Ranks</span>
                    </button>
                    <button onclick="showTab('stats')" id="stats-tab" class="tab-button flex-shrink-0 py-4 px-2 sm:px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-bold text-xs sm:text-sm whitespace-nowrap">
                        <span class="hidden sm:inline">Statistics</span>
                        <span class="sm:hidden">Stats</span>
                    </button>
                    {% if membership.is_admin %}
                    <button onclick="showTab('attributes')" id="attributes-tab" class="tab-button flex-shrink-0 py-4 px-2 sm:px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-bold text-xs sm:text-sm whitespace-nowrap">
                        <span class="hidden sm:inline">Player Attributes</span>
                        <span class="sm:hidden">Attrs</span>
                    </button>
                    {% endif %}
                </div>
            </nav>
        </div>
    </div>

    <!-- Tab Content -->
    <div id="overview-content" class="tab-content">
        <!-- Next Game Card -->
        {% if next_game %}
        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-start space-x-3">
                    <div class="h-12 w-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar text-blue-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">Next Game</h3>
                        <p class="text-sm text-gray-600 mt-1 font-medium">{{ next_game.datetime.strftime('%A, %B %d at %I:%M %p') }}</p>
                        {% if next_game.location %}
                            <p class="text-xs text-gray-500 flex items-center mt-1 font-medium">
                                <i class="fas fa-map-marker-alt mr-1"></i>
                                {{ next_game.location }}
                            </p>
                        {% endif %}
                    </div>
                </div>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">{{ next_game.status.title() }}</span>
            </div>
            
            {% if next_game.notes %}
            <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-100">
                <p class="text-xs text-gray-600">{{ next_game.notes }}</p>
            </div>
            {% endif %}
            
            <div class="flex flex-wrap gap-3">
                <a href="{{ url_for('games.view', game_id=next_game.id) }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                    <i class="fas fa-eye mr-2"></i>
                    View Details
                </a>
                <button onclick="shareGameInvite('{{ next_game.id }}', '{{ next_game.datetime.strftime('%A, %B %d at %I:%M %p') }}', '{{ group.name }}')" class="inline-flex items-center px-4 py-2 border border-blue-300 text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100">
                    <i class="fas fa-share-alt mr-2"></i>
                    Share Game
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Last Result -->
        {% if last_game and last_game.status == 'finished' %}
        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
            <div class="flex items-start space-x-3 mb-4">
                <div class="h-12 w-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-trophy text-green-600"></i>
                </div>
                <div>
                    <h3 class="text-lg font-black text-gray-900">Last Result</h3>
                    <p class="text-xs text-gray-500 mt-1">{{ last_game.datetime.strftime('%B %d, %Y') }}</p>
                </div>
            </div>
            {% set score = last_game.get_score() %}
            <div class="bg-white rounded-lg p-4 border border-gray-100 mb-4 shadow-sm">
                <div class="grid grid-cols-5 items-center text-center">
                    <div class="col-span-2">
                        <div class="text-sm font-semibold text-gray-700">Team A</div>
                    </div>
                    <div class="col-span-1">
                        <div class="text-3xl font-bold text-gray-900 font-mono">
                            <span class="text-blue-600">{{ score.team_a }}</span>
                            <span class="text-gray-300 mx-1">:</span>
                            <span class="text-red-600">{{ score.team_b }}</span>
                        </div>
                    </div>
                    <div class="col-span-2">
                        <div class="text-sm font-semibold text-gray-700">Team B</div>
                    </div>
                </div>
            </div>
            <a href="{{ url_for('games.view', game_id=last_game.id) }}" class="inline-flex items-center px-3 py-2 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <i class="fas fa-eye mr-1"></i>
                View Details
            </a>
        </div>
        {% endif %}


        <!-- Recent Activity -->
        {% if feed_items %}
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <div class="h-12 w-12 bg-gradient-to-br from-orange-100 to-orange-200 rounded-lg flex items-center justify-center">
                        <i class="fas fa-pulse text-orange-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-gray-900">Recent Activity</h3>
                        <p class="text-xs text-gray-500">Latest group updates and events</p>
                    </div>
                </div>
                <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full">Live</span>
            </div>
            
            <div class="flow-root">
                <ul class="-mb-8">
                    {% for item in feed_items[:5] %}
                    <li>
                        <div class="relative pb-8">
                            {% if not loop.last %}
                            <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
                            {% endif %}
                            <div class="relative flex space-x-3">
                                <!-- Activity Icon -->
                                <div>
                                    <span class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center ring-8 ring-white">
                                        {% if 'joined' in item.content.lower() %}
                                            <i class="fas fa-user-plus text-blue-600 text-xs"></i>
                                        {% elif 'game' in item.content.lower() %}
                                            <i class="fas fa-futbol text-blue-600 text-xs"></i>
                                        {% elif 'goal' in item.content.lower() %}
                                            <i class="fas fa-trophy text-blue-600 text-xs"></i>
                                        {% else %}
                                            <i class="fas fa-circle text-blue-600 text-xs"></i>
                                        {% endif %}
                                    </span>
                                </div>
                                <!-- Activity Content -->
                                <div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4">
                                    <div>
                                        <p class="text-sm text-gray-900 font-medium">{{ item.content }}</p>
                                    </div>
                                    <div class="text-right text-xs whitespace-nowrap text-gray-500">
                                        <time datetime="{{ item.created_at.isoformat() }}">
                                            {{ item.created_at.strftime('%b %d') }}
                                        </time>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            
            <!-- View All Activity Link -->
            <div class="mt-6 pt-4 border-t border-gray-100">
                <a href="{{ url_for('groups.activity', group_id=group.id) }}" class="block w-full text-center text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors">
                    View All Activity
                    <i class="fas fa-arrow-right ml-1 text-xs"></i>
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Games & History Tab -->
    <div id="games-content" class="tab-content hidden">
        <div class="space-y-6">
            <!-- All Games -->
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-3">
                        <div class="h-12 w-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar text-blue-600"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-black text-gray-900">All Games</h3>
                            <p class="text-xs text-gray-500">Upcoming and completed matches</p>
                        </div>
                    </div>
                    {% if membership.is_admin %}
                    <a href="{{ url_for('games.create', group_id=group.id) }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>
                        New Game
                    </a>
                    {% endif %}
                </div>
                
                {% if all_games %}
                    <div class="space-y-4">
                        {% for game in all_games %}
                            {% if game.status == 'upcoming' %}
                                {% set status_class = 'bg-blue-50 border-blue-200 text-blue-800' %}
                                {% set status_icon = 'fas fa-clock text-blue-600' %}
                                {% set badge_class = 'bg-blue-100 text-blue-800' %}
                            {% elif game.status == 'finished' %}
                                {% set status_class = 'bg-green-50 border-green-200 text-green-800' %}
                                {% set status_icon = 'fas fa-check-circle text-green-600' %}
                                {% set badge_class = 'bg-green-100 text-green-800' %}
                            {% else %}
                                {% set status_class = 'bg-gray-50 border-gray-200 text-gray-800' %}
                                {% set status_icon = 'fas fa-circle text-gray-600' %}
                                {% set badge_class = 'bg-gray-100 text-gray-800' %}
                            {% endif %}
                            
                            <div class="p-4 {{ status_class }} border rounded-lg hover:shadow-sm transition-shadow">
                                <div class="flex justify-between items-start">
                                    <div class="flex items-start space-x-3">
                                        <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center border shadow-sm">
                                            <i class="{{ status_icon }} text-sm"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-gray-900">{{ game.datetime.strftime('%A, %B %d, %Y') }}</h4>
                                            <p class="text-sm text-gray-600">{{ game.datetime.strftime('%I:%M %p') }}</p>
                                            {% if game.location %}
                                            <p class="text-xs text-gray-500 mt-1 flex items-center">
                                                <i class="fas fa-map-marker-alt mr-1"></i>{{ game.location }}
                                            </p>
                                            {% endif %}
                                            {% if game.notes %}
                                            <p class="text-xs text-gray-500 mt-1 flex items-start">
                                                <i class="fas fa-sticky-note mr-1 mt-0.5"></i>{{ game.notes }}
                                            </p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ badge_class }} mb-2">
                                            {{ game.status.title() }}
                                        </span>
                                        
                                        {% if game.status == 'finished' %}
                                            {% set score = game.get_score() %}
                                            <div class="bg-white rounded-md px-3 py-2 border border-gray-200 shadow-sm mb-2">
                                                <div class="text-lg font-bold text-gray-900 font-mono">
                                                    <span class="text-blue-600">{{ score.team_a }}</span>
                                                    <span class="text-gray-300 mx-1">-</span>
                                                    <span class="text-red-600">{{ score.team_b }}</span>
                                                </div>
                                                <p class="text-xs text-gray-500">Final Score</p>
                                            </div>
                                        {% elif game.status == 'upcoming' %}
                                            {% set responses = game.get_responses() %}
                                            <div class="text-xs text-gray-600 mb-2">
                                                <div>{{ responses.attending|length }} attending</div>
                                                <div>{{ responses.not_attending|length }} not attending</div>
                                                {% if game.is_poll_locked() %}
                                                    <div class="text-orange-600 font-medium">Poll Locked</div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                        
                                        <a href="{{ url_for('games.view', game_id=game.id) }}" class="inline-flex items-center text-xs text-blue-600 hover:text-blue-800 font-medium">
                                            View Details <i class="fas fa-arrow-right ml-1"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-calendar-plus text-4xl mb-4"></i>
                        <h4 class="text-lg font-medium text-gray-900 mb-2">No games scheduled</h4>
                        <p class="text-sm mb-6">Start organizing matches for your group</p>
                        {% if membership.is_admin %}
                        <a href="{{ url_for('games.create', group_id=group.id) }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>
                            Create First Game
                        </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Members Tab -->
    <div id="members-content" class="tab-content hidden">
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <div class="h-12 w-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-users text-purple-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-gray-900">All Members</h3>
                        <p class="text-xs text-gray-500 font-medium">{{ members|length }} total member{{ 's' if members|length != 1 else '' }}</p>
                    </div>
                </div>
                {% if membership.is_admin %}
                <div class="flex space-x-3">
                    <a href="{{ url_for('invites.manage_invite', group_id=group.id) }}" class="inline-flex items-center px-3 py-2 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-user-plus mr-1"></i>
                        Invite Members
                    </a>
                    <a href="{{ url_for('groups.members', group_id=group.id) }}" class="inline-flex items-center px-3 py-2 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-cog mr-1"></i>
                        Manage
                    </a>
                </div>
                {% endif %}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for member in members %}
                {% set member_membership = member.memberships|selectattr('group_id', 'equalto', group.id)|first %}
                <div class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                    <div class="flex items-center space-x-3">
                        <div class="relative inline-block h-10 w-10">
                            <img 
                                class="h-10 w-10 rounded-full object-cover border-2 border-indigo-200 shadow-sm" 
                                src="#" 
                                data-user-id="{{ member.id }}"
                                data-user-name="{{ member.display_name }}"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                            />
                            <div class="h-10 w-10 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-full flex items-center justify-center border-2 border-indigo-200 shadow-sm" style="display: none;">
                                <span class="text-sm font-bold text-white">
                                    {{ member.display_name[0].upper() }}
                                </span>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-bold text-gray-900 truncate">{{ member.display_name }}</h4>
                            <div class="flex items-center space-x-2 mt-1">
                                {% if member_membership.is_admin %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-crown mr-1"></i>
                                    Admin
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-800">
                                    Member
                                </span>
                                {% endif %}
                            </div>
                            <p class="text-xs text-gray-500 mt-1 font-medium">Joined {{ member_membership.joined_at.strftime('%b %Y') }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Leaderboard Tab -->
    <div id="leaderboard-content" class="tab-content hidden">
        <div class="bg-white rounded-lg border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="h-12 w-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-trophy text-yellow-600"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-black text-gray-900">Group Leaderboard</h3>
                            <p class="text-sm text-gray-500 font-medium">Player rankings based on match performance</p>
                        </div>
                    </div>
                    <div class="hidden sm:flex text-sm text-gray-600 bg-gray-50 px-3 py-1 rounded-lg">
                        <i class="fas fa-info-circle mr-1"></i>
                        Win: 3pts • Draw: 1pt • Loss: 0pts
                    </div>
                    <div class="sm:hidden text-xs text-gray-600 bg-gray-50 px-2 py-1 rounded">
                        <i class="fas fa-info-circle mr-1"></i>
                        3/1/0 pts
                    </div>
                </div>
            </div>

            {% if leaderboard_data %}
            <div class="overflow-x-auto">
                <table id="leaderboard-table" class="w-full min-w-max">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="sortable px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="rank">
                                <div class="flex items-center space-x-1">
                                    <span>Rank</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="player">
                                <div class="flex items-center space-x-1">
                                    <span>Player</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="points">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>Pts</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="games">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>GP</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="wins">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>W</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable hidden sm:table-cell px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="draws">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>D</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable hidden sm:table-cell px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="losses">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>L</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="goals">
                                <div class="flex items-center justify-center space-x-1">
                                    <span class="hidden sm:inline">Goals</span>
                                    <span class="sm:hidden">G</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable hidden md:table-cell px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="assists">
                                <div class="flex items-center justify-center space-x-1">
                                    <span class="hidden sm:inline">Assists</span>
                                    <span class="sm:hidden">A</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable hidden lg:table-cell px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="own_goals">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>OG</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable hidden lg:table-cell px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="potm">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>POTM</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable hidden md:table-cell px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-column="contributions">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>G+A</span>
                                    <i class="fas fa-sort text-gray-400 sort-icon"></i>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-tbody" class="bg-white divide-y divide-gray-200">
                        {% for player in leaderboard_data %}
                        <tr class="leaderboard-row hover:bg-gray-50" data-player-data='{{ player | tojson }}'>
                            <td class="px-2 sm:px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    {% if loop.index == 1 %}
                                    <div class="flex items-center justify-center w-8 h-8 bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-full text-white font-bold text-sm">
                                        <i class="fas fa-crown"></i>
                                    </div>
                                    {% elif loop.index == 2 %}
                                    <div class="flex items-center justify-center w-8 h-8 bg-gradient-to-r from-gray-300 to-gray-400 rounded-full text-white font-bold text-sm">
                                        2
                                    </div>
                                    {% elif loop.index == 3 %}
                                    <div class="flex items-center justify-center w-8 h-8 bg-gradient-to-r from-orange-300 to-orange-400 rounded-full text-white font-bold text-sm">
                                        3
                                    </div>
                                    {% else %}
                                    <div class="flex items-center justify-center w-8 h-8 bg-gray-100 rounded-full text-gray-600 font-semibold text-sm">
                                        {{ loop.index }}
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-2 sm:px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="relative inline-block h-8 w-8 sm:h-10 sm:w-10 mr-2 sm:mr-3">
                                        <img 
                                            class="h-8 w-8 sm:h-10 sm:w-10 rounded-full object-cover border border-gray-200" 
                                            src="#" 
                                            data-user-id="{{ player.user_id }}"
                                            data-user-name="{{ player.display_name }}"
                                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                        />
                                        <div class="h-8 w-8 sm:h-10 sm:w-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center border border-gray-200" style="display: none;">
                                            <span class="text-xs sm:text-sm font-bold text-white">
                                                {{ player.display_name[0].upper() }}
                                            </span>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-xs sm:text-sm font-semibold text-gray-900 truncate max-w-24 sm:max-w-none">{{ player.display_name }}</div>
                                        {% if player.user_id == current_user.id %}
                                        <div class="text-xs text-blue-600 font-bold">You</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-center">
                                <div class="inline-flex items-center px-1.5 sm:px-2.5 py-0.5 rounded-full text-xs sm:text-sm font-medium bg-blue-100 text-blue-800">
                                    {{ player.points }}
                                </div>
                            </td>
                            <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900 text-center">{{ player.games_played }}</td>
                            <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-center">
                                <span class="inline-flex items-center px-1.5 sm:px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    {{ player.wins }}
                                </span>
                            </td>
                            <td class="hidden sm:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-center">
                                <span class="inline-flex items-center px-1.5 sm:px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    {{ player.draws }}
                                </span>
                            </td>
                            <td class="hidden sm:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-center">
                                <span class="inline-flex items-center px-1.5 sm:px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    {{ player.losses }}
                                </span>
                            </td>
                            <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900 text-center">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-futbol text-blue-500 mr-1 text-xs hidden sm:inline"></i>
                                    <span class="font-semibold">{{ player.goals }}</span>
                                </div>
                            </td>
                            <td class="hidden md:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900 text-center">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-hands-helping text-green-500 mr-1 text-xs hidden sm:inline"></i>
                                    <span class="font-semibold">{{ player.assists }}</span>
                                </div>
                            </td>
                            <td class="hidden lg:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900 text-center">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-orange-500 mr-1 text-xs hidden sm:inline"></i>
                                    <span class="font-semibold text-orange-700">{{ player.own_goals }}</span>
                                </div>
                            </td>
                            <td class="hidden lg:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900 text-center">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-star text-yellow-500 mr-1 text-xs hidden sm:inline"></i>
                                    <span class="font-semibold">{{ player.potm_awards }}</span>
                                </div>
                            </td>
                            <td class="hidden md:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-xs sm:text-sm text-center">
                                <div class="inline-flex items-center px-1.5 sm:px-2.5 py-0.5 rounded-full text-xs sm:text-sm font-bold bg-purple-100 text-purple-800">
                                    {{ player.total_contributions }}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12">
                <div class="h-16 w-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-trophy text-yellow-600 text-xl"></i>
                </div>
                <h4 class="text-lg font-medium text-gray-900 mb-2">No match data yet</h4>
                <p class="text-sm text-gray-500 mb-4">The leaderboard will show player rankings after matches are completed</p>
                {% if membership.is_admin %}
                <a href="{{ url_for('games.create', group_id=group.id) }}" 
                   class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                    <i class="fas fa-plus mr-2"></i>
                    Create First Game
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Statistics Tab -->
    <div id="stats-content" class="tab-content hidden">
        <div class="space-y-6">
            <!-- Group Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-gamepad text-blue-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-2xl font-bold text-gray-900">{{ group_stats.total_games if group_stats else 0 }}</div>
                            <div class="text-sm text-gray-500 font-medium">Total Games</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-trophy text-green-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-2xl font-bold text-gray-900">{{ group_stats.total_goals if group_stats else 0 }}</div>
                            <div class="text-sm text-gray-500 font-medium">Goals Scored</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-percentage text-purple-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-2xl font-bold text-gray-900">{{ group_stats.attendance_rate if group_stats else 0 }}%</div>
                            <div class="text-sm text-gray-500 font-medium">Attendance Rate</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Players -->
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="h-12 w-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-star text-yellow-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-gray-900">Top Players</h3>
                        <p class="text-xs text-gray-500 font-medium">Based on goals and participation</p>
                    </div>
                </div>
                
                {% if group_stats and group_stats.total_games > 0 %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% if group_stats.top_scorer %}
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-4 border border-yellow-200">
                        <div class="flex items-center space-x-3">
                            <div class="h-10 w-10 bg-yellow-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-crown text-yellow-600"></i>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-gray-900">Top Scorer</div>
                                <div class="text-lg font-black text-yellow-800">{{ group_stats.top_scorer[0] }}</div>
                                <div class="text-xs text-gray-600 font-medium">{{ group_stats.top_scorer[1] }} goal{{ 's' if group_stats.top_scorer[1] != 1 else '' }}</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if group_stats.most_active_player %}
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200">
                        <div class="flex items-center space-x-3">
                            <div class="h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-medal text-blue-600"></i>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-gray-900">Most Active</div>
                                <div class="text-lg font-black text-blue-800">{{ group_stats.most_active_player[0] }}</div>
                                <div class="text-xs text-gray-600 font-medium">{{ group_stats.most_active_player[1] }} game{{ 's' if group_stats.most_active_player[1] != 1 else '' }}</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Additional Stats -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-sm font-bold text-gray-900 mb-3">Quick Stats</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-lg font-bold text-gray-900">{{ group_stats.average_goals_per_game }}</div>
                            <div class="text-xs text-gray-500 font-medium">Avg Goals/Game</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-gray-900">{{ group_stats.total_assists }}</div>
                            <div class="text-xs text-gray-500 font-medium">Total Assists</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-gray-900">{{ group_stats.upcoming_games }}</div>
                            <div class="text-xs text-gray-500 font-medium">Upcoming Games</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-gray-900">{{ group_stats.total_own_goals }}</div>
                            <div class="text-xs text-gray-500 font-medium">Own Goals</div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-chart-bar text-3xl mb-4"></i>
                    <p class="font-medium">Statistics will appear after games are played</p>
                    <p class="text-xs mt-2 font-medium">Goals, assists, and POTM awards will be tracked here</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Player Attributes Tab (Admin Only) -->
    {% if membership.is_admin %}
    <div id="attributes-content" class="tab-content hidden">
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <div class="h-12 w-12 bg-indigo-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-radar text-indigo-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-gray-900">Player Attributes</h3>
                        <p class="text-sm text-gray-500 font-medium">Manage and rate player skills and abilities</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">Admin Only</span>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="mb-6 flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="player-search" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Search players...">
                    </div>
                </div>
                <div class="sm:w-48">
                    <select id="position-filter" class="block w-full px-3 py-2 border border-gray-300 rounded-md bg-white text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Positions</option>
                        <option value="GK">Goalkeeper</option>
                        <option value="DEF">Defender</option>
                        <option value="MID">Midfielder</option>
                        <option value="FWD">Forward</option>
                    </select>
                </div>
            </div>

            <!-- Players Grid -->
            <div id="players-attributes-grid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                {% for member in members %}
                {% set member_attributes = player_attributes.get(member.id) %}
                <div class="player-card border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow duration-200" 
                     data-player-id="{{ member.id }}" 
                     data-player-name="{{ member.display_name.lower() }}"
                     data-player-position="{{ member_attributes.preferred_position if member_attributes else '' }}">
                    
                    <!-- Player Header -->
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="h-12 w-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-lg font-semibold text-blue-700">
                                {{ member.display_name[0].upper() }}
                            </span>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-gray-900">{{ member.display_name }}</h4>
                            <div class="flex items-center space-x-2 mt-1">
                                {% if member_attributes and member_attributes.preferred_position %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    {% if member_attributes.preferred_position == 'GK' %}
                                        <i class="fas fa-hand-paper mr-1"></i>Goalkeeper
                                    {% elif member_attributes.preferred_position == 'DEF' %}
                                        <i class="fas fa-shield-alt mr-1"></i>Defender
                                    {% elif member_attributes.preferred_position == 'MID' %}
                                        <i class="fas fa-cogs mr-1"></i>Midfielder
                                    {% elif member_attributes.preferred_position == 'FWD' %}
                                        <i class="fas fa-running mr-1"></i>Forward
                                    {% endif %}
                                </span>
                                {% endif %}
                                {% if member_attributes %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                    {{ member_attributes.get_overall_rating() }}/10
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Attributes Overview -->
                    {% if member_attributes %}
                    <div class="space-y-3">
                        {% set categories = member_attributes.get_attribute_categories() %}
                        
                        <!-- Physical -->
                        <div class="bg-red-50 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-red-700">
                                    <i class="fas fa-dumbbell mr-1"></i>Physical
                                </span>
                                <span class="text-sm font-bold text-red-800">
                                    {{ "%.1f"|format((categories.physical.pace + categories.physical.stamina + categories.physical.strength + categories.physical.agility + categories.physical.jumping) / 5) }}
                                </span>
                            </div>
                            <div class="flex space-x-1">
                                {% for attr, value in categories.physical.items() %}
                                <div class="flex-1 bg-red-200 rounded-full h-2">
                                    <div class="bg-red-500 h-2 rounded-full" style="width: {{ value * 10 }}%"></div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Technical -->
                        <div class="bg-blue-50 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-blue-700">
                                    <i class="fas fa-futbol mr-1"></i>Technical
                                </span>
                                <span class="text-sm font-bold text-blue-800">
                                    {{ "%.1f"|format((categories.technical.ball_control + categories.technical.dribbling + categories.technical.passing + categories.technical.shooting + categories.technical.crossing + categories.technical.free_kicks) / 6) }}
                                </span>
                            </div>
                            <div class="flex space-x-1">
                                {% for attr, value in categories.technical.items() %}
                                <div class="flex-1 bg-blue-200 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: {{ value * 10 }}%"></div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Tactical -->
                        <div class="bg-green-50 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-green-700">
                                    <i class="fas fa-chess mr-1"></i>Tactical
                                </span>
                                <span class="text-sm font-bold text-green-800">
                                    {{ "%.1f"|format((categories.tactical.positioning + categories.tactical.marking + categories.tactical.tackling + categories.tactical.interceptions + categories.tactical.vision + categories.tactical.decision_making) / 6) }}
                                </span>
                            </div>
                            <div class="flex space-x-1">
                                {% for attr, value in categories.tactical.items() %}
                                <div class="flex-1 bg-green-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: {{ value * 10 }}%"></div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Mental -->
                        <div class="bg-purple-50 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-purple-700">
                                    <i class="fas fa-brain mr-1"></i>Mental
                                </span>
                                <span class="text-sm font-bold text-purple-800">
                                    {{ "%.1f"|format((categories.mental.composure + categories.mental.concentration + categories.mental.determination + categories.mental.leadership + categories.mental.teamwork) / 5) }}
                                </span>
                            </div>
                            <div class="flex space-x-1">
                                {% for attr, value in categories.mental.items() %}
                                <div class="flex-1 bg-purple-200 rounded-full h-2">
                                    <div class="bg-purple-500 h-2 rounded-full" style="width: {{ value * 10 }}%"></div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        {% if member_attributes.preferred_position == 'GK' %}
                        <!-- Goalkeeping -->
                        <div class="bg-yellow-50 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-yellow-700">
                                    <i class="fas fa-hand-paper mr-1"></i>Goalkeeping
                                </span>
                                <span class="text-sm font-bold text-yellow-800">
                                    {{ "%.1f"|format((categories.goalkeeping.goalkeeping + categories.goalkeeping.handling + categories.goalkeeping.distribution + categories.goalkeeping.aerial_reach) / 4) }}
                                </span>
                            </div>
                            <div class="flex space-x-1">
                                {% for attr, value in categories.goalkeeping.items() %}
                                <div class="flex-1 bg-yellow-200 rounded-full h-2">
                                    <div class="bg-yellow-500 h-2 rounded-full" style="width: {{ value * 10 }}%"></div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if member_attributes.notes %}
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-sticky-note mr-1 text-gray-400"></i>
                                {{ member_attributes.notes }}
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <!-- No attributes set -->
                    <div class="text-center py-6">
                        <div class="h-12 w-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-user-slash text-gray-400"></i>
                        </div>
                        <p class="text-sm text-gray-500 mb-3">No attributes set</p>
                    </div>
                    {% endif %}

                    <!-- Action Button -->
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <button onclick="editPlayerAttributes({{ member.id }}, '{{ member.display_name }}')" 
                                class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-edit mr-2"></i>
                            {% if member_attributes %}Edit Attributes{% else %}Set Attributes{% endif %}
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- No players message -->
            {% if not members %}
            <div class="text-center py-12">
                <div class="h-16 w-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-users text-indigo-600 text-xl"></i>
                </div>
                <h4 class="text-lg font-medium text-gray-900 mb-2">No members yet</h4>
                <p class="text-sm text-gray-500 mb-4">Invite members to start managing player attributes</p>
                <a href="{{ url_for('invites.manage_invite', group_id=group.id) }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                    <i class="fas fa-user-plus mr-2"></i>
                    Invite Members
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
function showTab(tabName) {
    // Hide all tab contents
    const contents = document.querySelectorAll('.tab-content');
    contents.forEach(content => content.classList.add('hidden'));
    
    // Show selected tab content
    const targetContent = document.getElementById(tabName + '-content');
    if (targetContent) {
        targetContent.classList.remove('hidden');
    }
    
    // Update tab button styles
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(button => {
        button.classList.remove('border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Highlight active tab
    const activeButton = document.getElementById(tabName + '-tab');
    if (activeButton) {
        activeButton.classList.remove('border-transparent', 'text-gray-500');
        activeButton.classList.add('border-blue-500', 'text-blue-600');
    }
}

// Initialize with appropriate tab based on URL hash or default to overview
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    const tabName = hash ? hash.substring(1) : 'overview';
    
    // Check if the tab exists, otherwise default to overview
    const validTabs = ['overview', 'games', 'members', 'leaderboard', 'stats', 'attributes'];
    const targetTab = validTabs.includes(tabName) ? tabName : 'overview';
    
    showTab(targetTab);
});

// Add click event listeners for tabs (backup in case onclick fails)
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.id.replace('-tab', '');
            showTab(tabName);
        });
    });
});

// Game invite sharing functionality
function shareGameInvite(gameId, gameTime, groupName) {
    // Create the shareable game URL
    const gameUrl = `${window.location.origin}/games/${gameId}`;
    const shareText = `🏈 Join us for football!\n\n${groupName}\n${gameTime}\n\nClick to vote on your availability:\n${gameUrl}`;
    
    // Check if the Web Share API is available
    if (navigator.share) {
        navigator.share({
            title: `${groupName} - Football Game`,
            text: shareText,
            url: gameUrl
        }).then(() => {
            console.log('Shared successfully');
        }).catch((error) => {
            console.log('Error sharing:', error);
            fallbackShare(shareText);
        });
    } else {
        fallbackShare(shareText);
    }
}

// Fallback sharing method
function fallbackShare(shareText) {
    // Try to copy to clipboard
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(shareText).then(() => {
            showToast('Game invite copied to clipboard!', 'success');
        }).catch(() => {
            showShareModal(shareText);
        });
    } else {
        showShareModal(shareText);
    }
}

// Show share modal with the text
function showShareModal(shareText) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
    modal.innerHTML = `
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Share Game Invite</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mt-2 px-4 py-3 bg-gray-50 rounded-lg">
                    <textarea id="shareText" class="w-full h-32 text-sm text-gray-700 bg-transparent border-none resize-none focus:outline-none" readonly>${shareText}</textarea>
                </div>
                <div class="items-center px-4 py-3">
                    <button onclick="copyShareText()" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700">
                        <i class="fas fa-copy mr-2"></i>Copy to Clipboard
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Copy share text function
function copyShareText() {
    const textArea = document.getElementById('shareText');
    textArea.select();
    document.execCommand('copy');
    showToast('Copied to clipboard!', 'success');
    document.querySelector('.fixed').remove();
}

// Toast notifications are now handled globally by base.html

// Leaderboard sorting functionality
let currentSortColumn = 'points';
let currentSortDirection = 'desc';

function initializeLeaderboardSorting() {
    const sortableHeaders = document.querySelectorAll('.sortable');
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.getAttribute('data-column');
            sortLeaderboard(column);
        });
    });
    
    // Set initial sort indicators
    updateSortIndicators();
}

function sortLeaderboard(column) {
    const tbody = document.getElementById('leaderboard-tbody');
    const rows = Array.from(tbody.querySelectorAll('.leaderboard-row'));
    
    // Determine sort direction
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = column;
        currentSortDirection = getDefaultSortDirection(column);
    }
    
    // Sort rows based on column and direction
    rows.sort((a, b) => {
        const aData = JSON.parse(a.getAttribute('data-player-data'));
        const bData = JSON.parse(b.getAttribute('data-player-data'));
        
        let aValue, bValue;
        
        switch(column) {
            case 'rank':
                aValue = getCurrentRank(a);
                bValue = getCurrentRank(b);
                break;
            case 'player':
                aValue = aData.display_name.toLowerCase();
                bValue = bData.display_name.toLowerCase();
                break;
            case 'points':
                aValue = aData.points;
                bValue = bData.points;
                break;
            case 'games':
                aValue = aData.games_played;
                bValue = bData.games_played;
                break;
            case 'wins':
                aValue = aData.wins;
                bValue = bData.wins;
                break;
            case 'draws':
                aValue = aData.draws;
                bValue = bData.draws;
                break;
            case 'losses':
                aValue = aData.losses;
                bValue = bData.losses;
                break;
            case 'goals':
                aValue = aData.goals;
                bValue = bData.goals;
                break;
            case 'assists':
                aValue = aData.assists;
                bValue = bData.assists;
                break;
            case 'own_goals':
                aValue = aData.own_goals;
                bValue = bData.own_goals;
                break;
            case 'potm':
                aValue = aData.potm_awards;
                bValue = bData.potm_awards;
                break;
            case 'contributions':
                aValue = aData.total_contributions;
                bValue = bData.total_contributions;
                break;
            default:
                return 0;
        }
        
        // Handle string vs number comparison
        if (typeof aValue === 'string') {
            return currentSortDirection === 'asc' ? 
                aValue.localeCompare(bValue) : 
                bValue.localeCompare(aValue);
        } else {
            return currentSortDirection === 'asc' ? 
                aValue - bValue : 
                bValue - aValue;
        }
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
    
    // Update rank numbers if sorting by rank
    if (column === 'rank') {
        updateRankNumbers();
    }
    
    // Update sort indicators
    updateSortIndicators();
}

function getCurrentRank(row) {
    const rankCell = row.querySelector('td:first-child div');
    const crownIcon = rankCell.querySelector('i.fa-crown');
    if (crownIcon) return 1;
    
    const rankText = rankCell.textContent.trim();
    return parseInt(rankText) || 999;
}

function getDefaultSortDirection(column) {
    // Most columns should sort high to low by default
    const ascendingColumns = ['player', 'rank', 'own_goals'];
    return ascendingColumns.includes(column) ? 'asc' : 'desc';
}

function updateSortIndicators() {
    // Reset all sort icons
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.className = 'fas fa-sort text-gray-400 sort-icon';
    });
    
    // Update active sort icon
    const activeHeader = document.querySelector(`[data-column="${currentSortColumn}"]`);
    if (activeHeader) {
        const sortIcon = activeHeader.querySelector('.sort-icon');
        if (currentSortDirection === 'asc') {
            sortIcon.className = 'fas fa-sort-up text-blue-600 sort-icon';
        } else {
            sortIcon.className = 'fas fa-sort-down text-blue-600 sort-icon';
        }
    }
}

function updateRankNumbers() {
    const tbody = document.getElementById('leaderboard-tbody');
    const rows = Array.from(tbody.querySelectorAll('.leaderboard-row'));
    
    rows.forEach((row, index) => {
        const rankCell = row.querySelector('td:first-child div');
        const rank = index + 1;
        
        // Update rank display
        if (rank === 1) {
            rankCell.innerHTML = '<i class="fas fa-crown"></i>';
            rankCell.className = 'flex items-center justify-center w-8 h-8 bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-full text-white font-bold text-sm';
        } else if (rank === 2) {
            rankCell.textContent = '2';
            rankCell.className = 'flex items-center justify-center w-8 h-8 bg-gradient-to-r from-gray-300 to-gray-400 rounded-full text-white font-bold text-sm';
        } else if (rank === 3) {
            rankCell.textContent = '3';
            rankCell.className = 'flex items-center justify-center w-8 h-8 bg-gradient-to-r from-orange-300 to-orange-400 rounded-full text-white font-bold text-sm';
        } else {
            rankCell.textContent = rank;
            rankCell.className = 'flex items-center justify-center w-8 h-8 bg-gray-100 rounded-full text-gray-600 font-semibold text-sm';
        }
    });
}

// Initialize leaderboard sorting when document is loaded
document.addEventListener('DOMContentLoaded', function() {
    showTab('overview');
    initializeLeaderboardSorting();
    initializePlayerAttributesSearch();
});

// Player Attributes Search and Filter functionality
function initializePlayerAttributesSearch() {
    const searchInput = document.getElementById('player-search');
    const positionFilter = document.getElementById('position-filter');
    
    if (searchInput) {
        searchInput.addEventListener('input', filterPlayers);
    }
    if (positionFilter) {
        positionFilter.addEventListener('change', filterPlayers);
    }
}

function filterPlayers() {
    const searchTerm = document.getElementById('player-search').value.toLowerCase();
    const positionFilter = document.getElementById('position-filter').value;
    const playerCards = document.querySelectorAll('.player-card');
    
    playerCards.forEach(card => {
        const playerName = card.getAttribute('data-player-name');
        const playerPosition = card.getAttribute('data-player-position');
        
        const matchesSearch = playerName.includes(searchTerm);
        const matchesPosition = !positionFilter || playerPosition === positionFilter;
        
        if (matchesSearch && matchesPosition) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// Edit Player Attributes Modal
function editPlayerAttributes(playerId, playerName) {
    // Create compact modal HTML
    const modalHtml = `
        <div id="attributes-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-4 mx-auto p-4 border w-full max-w-6xl shadow-lg rounded-md bg-white mb-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-chart-radar text-indigo-600 mr-2"></i>
                        Edit Attributes - ${playerName}
                    </h3>
                    <button onclick="closeAttributesModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                
                <form id="attributes-form" class="space-y-4">
                    <input type="hidden" name="player_id" value="${playerId}">
                    
                    <!-- Position Selection -->
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="flex items-center space-x-4">
                            <label class="text-sm font-medium text-gray-900 flex items-center">
                                <i class="fas fa-map-marker-alt text-gray-600 mr-2"></i>
                                Position:
                            </label>
                            <select name="preferred_position" class="px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select Position</option>
                                <option value="GK">Goalkeeper</option>
                                <option value="DEF">Defender</option>
                                <option value="MID">Midfielder</option>
                                <option value="FWD">Forward</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Compact Attributes Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <!-- Physical & Technical Combined -->
                        <div class="bg-red-50 rounded-lg p-3">
                            <h4 class="text-sm font-medium text-red-800 mb-3 flex items-center">
                                <i class="fas fa-dumbbell mr-2 text-xs"></i>Physical
                            </h4>
                            <div class="space-y-2">
                                ${createCompactAttributeSlider('pace', 'Pace')}
                                ${createCompactAttributeSlider('stamina', 'Stamina')}
                                ${createCompactAttributeSlider('strength', 'Strength')}
                                ${createCompactAttributeSlider('agility', 'Agility')}
                                ${createCompactAttributeSlider('jumping', 'Jumping')}
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 rounded-lg p-3">
                            <h4 class="text-sm font-medium text-blue-800 mb-3 flex items-center">
                                <i class="fas fa-futbol mr-2 text-xs"></i>Technical
                            </h4>
                            <div class="space-y-2">
                                ${createCompactAttributeSlider('ball_control', 'Ball Control')}
                                ${createCompactAttributeSlider('dribbling', 'Dribbling')}
                                ${createCompactAttributeSlider('passing', 'Passing')}
                                ${createCompactAttributeSlider('shooting', 'Shooting')}
                                ${createCompactAttributeSlider('crossing', 'Crossing')}
                                ${createCompactAttributeSlider('free_kicks', 'Free Kicks')}
                            </div>
                        </div>
                        
                        <div class="bg-green-50 rounded-lg p-3">
                            <h4 class="text-sm font-medium text-green-800 mb-3 flex items-center">
                                <i class="fas fa-chess mr-2 text-xs"></i>Tactical
                            </h4>
                            <div class="space-y-2">
                                ${createCompactAttributeSlider('positioning', 'Positioning')}
                                ${createCompactAttributeSlider('marking', 'Marking')}
                                ${createCompactAttributeSlider('tackling', 'Tackling')}
                                ${createCompactAttributeSlider('interceptions', 'Interceptions')}
                                ${createCompactAttributeSlider('vision', 'Vision')}
                                ${createCompactAttributeSlider('decision_making', 'Decision Making')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mental & Goalkeeping Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="bg-purple-50 rounded-lg p-3">
                            <h4 class="text-sm font-medium text-purple-800 mb-3 flex items-center">
                                <i class="fas fa-brain mr-2 text-xs"></i>Mental
                            </h4>
                            <div class="grid grid-cols-2 gap-2">
                                ${createCompactAttributeSlider('composure', 'Composure')}
                                ${createCompactAttributeSlider('concentration', 'Concentration')}
                                ${createCompactAttributeSlider('determination', 'Determination')}
                                ${createCompactAttributeSlider('leadership', 'Leadership')}
                                ${createCompactAttributeSlider('teamwork', 'Teamwork')}
                            </div>
                        </div>
                        
                        <!-- Goalkeeping Attributes -->
                        <div id="goalkeeping-section" class="bg-yellow-50 rounded-lg p-3" style="display: none;">
                            <h4 class="text-sm font-medium text-yellow-800 mb-3 flex items-center">
                                <i class="fas fa-hand-paper mr-2 text-xs"></i>Goalkeeping
                            </h4>
                            <div class="grid grid-cols-2 gap-2">
                                ${createCompactAttributeSlider('goalkeeping', 'Goalkeeping')}
                                ${createCompactAttributeSlider('handling', 'Handling')}
                                ${createCompactAttributeSlider('distribution', 'Distribution')}
                                ${createCompactAttributeSlider('aerial_reach', 'Aerial Reach')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="bg-gray-50 rounded-lg p-3">
                        <label class="text-sm font-medium text-gray-800 flex items-center mb-2">
                            <i class="fas fa-sticky-note mr-2 text-xs"></i>Notes
                        </label>
                        <textarea name="notes" rows="2" class="block w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Additional notes about the player..."></textarea>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex justify-end space-x-3 pt-3 border-t border-gray-200">
                        <button type="button" onclick="closeAttributesModal()" class="px-4 py-2 border border-gray-300 text-sm font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" class="px-6 py-2 border border-transparent text-sm font-medium rounded text-white bg-indigo-600 hover:bg-indigo-700">
                            <i class="fas fa-save mr-2"></i>Save Attributes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    // Insert modal into DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Initialize modal functionality
    initializeAttributesModal(playerId);
}

function createAttributeSlider(name, label, description) {
    return `
        <div>
            <div class="flex justify-between items-center mb-2">
                <label class="block text-sm font-medium text-gray-700">${label}</label>
                <span id="${name}-value" class="text-sm font-bold text-gray-900">5</span>
            </div>
            <input type="range" name="${name}" id="${name}-slider" min="1" max="10" value="5" 
                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                   oninput="updateSliderValue('${name}')">
            <div class="text-xs text-gray-500 mt-1">${description}</div>
        </div>
    `;
}

function createCompactAttributeSlider(name, label) {
    return `
        <div>
            <div class="flex justify-between items-center mb-1">
                <label class="block text-xs font-medium text-gray-700">${label}</label>
                <span id="${name}-value" class="text-xs font-bold text-gray-900 min-w-[20px] text-center">5</span>
            </div>
            <input type="range" name="${name}" id="${name}-slider" min="1" max="10" value="5" 
                   class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                   oninput="updateSliderValue('${name}')">
        </div>
    `;
}

function updateSliderValue(attributeName) {
    const slider = document.getElementById(attributeName + '-slider');
    const valueDisplay = document.getElementById(attributeName + '-value');
    valueDisplay.textContent = slider.value;
}

function initializeAttributesModal(playerId) {
    const form = document.getElementById('attributes-form');
    const positionSelect = form.querySelector('[name="preferred_position"]');
    const goalkeepingSection = document.getElementById('goalkeeping-section');
    
    // Show/hide goalkeeping section based on position
    positionSelect.addEventListener('change', function() {
        if (this.value === 'GK') {
            goalkeepingSection.style.display = 'block';
        } else {
            goalkeepingSection.style.display = 'none';
        }
    });
    
    // Load existing attributes if they exist
    loadPlayerAttributes(playerId);
    
    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        savePlayerAttributes();
    });
}

function loadPlayerAttributes(playerId) {
    fetch(`/groups/{{ group.id }}/players/${playerId}/attributes`)
        .then(response => response.json())
        .then(data => {
            if (data.attributes) {
                const form = document.getElementById('attributes-form');
                const attributes = data.attributes;
                
                // Set position
                if (attributes.preferred_position) {
                    form.querySelector('[name="preferred_position"]').value = attributes.preferred_position;
                    
                    // Show goalkeeping section if GK
                    if (attributes.preferred_position === 'GK') {
                        document.getElementById('goalkeeping-section').style.display = 'block';
                    }
                }
                
                // Set all attribute values
                const attributeNames = [
                    'pace', 'stamina', 'strength', 'agility', 'jumping',
                    'ball_control', 'dribbling', 'passing', 'shooting', 'crossing', 'free_kicks',
                    'positioning', 'marking', 'tackling', 'interceptions', 'vision', 'decision_making',
                    'composure', 'concentration', 'determination', 'leadership', 'teamwork',
                    'goalkeeping', 'handling', 'distribution', 'aerial_reach'
                ];
                
                attributeNames.forEach(attr => {
                    if (attributes[attr] !== undefined) {
                        const slider = document.getElementById(attr + '-slider');
                        const valueDisplay = document.getElementById(attr + '-value');
                        if (slider && valueDisplay) {
                            slider.value = attributes[attr];
                            valueDisplay.textContent = attributes[attr];
                        }
                    }
                });
                
                // Set notes
                if (attributes.notes) {
                    form.querySelector('[name="notes"]').value = attributes.notes;
                }
            }
        })
        .catch(error => {
            console.error('Error loading player attributes:', error);
        });
}

function savePlayerAttributes() {
    const form = document.getElementById('attributes-form');
    const formData = new FormData(form);
    const playerId = formData.get('player_id');
    
    fetch(`/groups/{{ group.id }}/players/${playerId}/attributes`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeAttributesModal();
            // Stay on the attributes tab and update the player's card
            showTab('attributes');
            // Update the specific player's card with new data
            const playerId = document.getElementById('attributes-form').querySelector('[name="player_id"]').value;
            updatePlayerCard(playerId);
        } else {
            showToast(data.error || 'Failed to update attributes', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving player attributes:', error);
        showToast('Error saving attributes', 'error');
    });
}

function updatePlayerCard(playerId) {
    // Fetch updated player data and re-render their card
    fetch(`/groups/{{ group.id }}/players/${playerId}/attributes`)
        .then(response => response.json())
        .then(data => {
            if (data.attributes) {
                // Find the player card element
                const playerCard = document.querySelector(`[data-player-id="${playerId}"]`);
                if (playerCard) {
                    // Update the card content with new attributes
                    updatePlayerCardDisplay(playerCard, data.attributes, data.player_name);
                    showToast('Player attributes updated successfully!', 'success');
                } else {
                    // Card not found, just show success message
                    showToast('Player attributes updated successfully!', 'success');
                }
            } else {
                showToast('Player attributes updated successfully!', 'success');
            }
        })
        .catch(error => {
            console.error('Error updating player card:', error);
            // Show success message since the save actually worked
            showToast('Player attributes updated successfully!', 'success');
        });
}

function updatePlayerCardDisplay(playerCard, attributes, playerName) {
    // Calculate category averages
    const categories = {
        physical: {
            pace: attributes.pace || 5,
            stamina: attributes.stamina || 5,
            strength: attributes.strength || 5,
            agility: attributes.agility || 5,
            jumping: attributes.jumping || 5
        },
        technical: {
            ball_control: attributes.ball_control || 5,
            dribbling: attributes.dribbling || 5,
            passing: attributes.passing || 5,
            shooting: attributes.shooting || 5,
            crossing: attributes.crossing || 5,
            free_kicks: attributes.free_kicks || 5
        },
        tactical: {
            positioning: attributes.positioning || 5,
            marking: attributes.marking || 5,
            tackling: attributes.tackling || 5,
            interceptions: attributes.interceptions || 5,
            vision: attributes.vision || 5,
            decision_making: attributes.decision_making || 5
        },
        mental: {
            composure: attributes.composure || 5,
            concentration: attributes.concentration || 5,
            determination: attributes.determination || 5,
            leadership: attributes.leadership || 5,
            teamwork: attributes.teamwork || 5
        }
    };

    // Add goalkeeping if position is GK
    if (attributes.preferred_position === 'GK') {
        categories.goalkeeping = {
            goalkeeping: attributes.goalkeeping || 1,
            handling: attributes.handling || 1,
            distribution: attributes.distribution || 1,
            aerial_reach: attributes.aerial_reach || 1
        };
    }

    // Calculate averages
    const categoryAverages = {};
    for (const [categoryName, categoryAttrs] of Object.entries(categories)) {
        const values = Object.values(categoryAttrs);
        categoryAverages[categoryName] = values.reduce((a, b) => a + b, 0) / values.length;
    }

    // Update the player card data attributes
    playerCard.setAttribute('data-player-position', attributes.preferred_position || '');
    
    // Find the position badge and update it
    const positionBadge = playerCard.querySelector('.bg-green-100');
    if (positionBadge && attributes.preferred_position) {
        let positionText = '';
        let icon = '';
        
        switch(attributes.preferred_position) {
            case 'GK':
                icon = 'fas fa-hand-paper';
                positionText = 'Goalkeeper';
                break;
            case 'DEF':
                icon = 'fas fa-shield-alt';
                positionText = 'Defender';
                break;
            case 'MID':
                icon = 'fas fa-cogs';
                positionText = 'Midfielder';
                break;
            case 'FWD':
                icon = 'fas fa-running';
                positionText = 'Forward';
                break;
        }
        
        positionBadge.innerHTML = `<i class="${icon} mr-1"></i>${positionText}`;
    }

    // Generate progress bars HTML
    function generateProgressBars(categoryAttrs, colorClass) {
        return Object.values(categoryAttrs).map(value => 
            `<div class="flex-1 bg-${colorClass}-200 rounded-full h-2">
                <div class="bg-${colorClass}-500 h-2 rounded-full" style="width: ${value * 10}%"></div>
            </div>`
        ).join('');
    }

    // Find the attributes container and update it
    const attributesContainer = playerCard.querySelector('.space-y-3');
    if (attributesContainer) {
        let newContent = '';
        
        // Physical attributes
        newContent += `
            <div class="bg-red-50 rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-red-700">
                        <i class="fas fa-running mr-1"></i>Physical
                    </span>
                    <span class="text-sm font-bold text-red-800">
                        ${categoryAverages.physical.toFixed(1)}
                    </span>
                </div>
                <div class="flex space-x-1">
                    ${generateProgressBars(categories.physical, 'red')}
                </div>
            </div>`;

        // Technical attributes
        newContent += `
            <div class="bg-blue-50 rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-blue-700">
                        <i class="fas fa-futbol mr-1"></i>Technical
                    </span>
                    <span class="text-sm font-bold text-blue-800">
                        ${categoryAverages.technical.toFixed(1)}
                    </span>
                </div>
                <div class="flex space-x-1">
                    ${generateProgressBars(categories.technical, 'blue')}
                </div>
            </div>`;

        // Tactical attributes
        newContent += `
            <div class="bg-green-50 rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-green-700">
                        <i class="fas fa-chess mr-1"></i>Tactical
                    </span>
                    <span class="text-sm font-bold text-green-800">
                        ${categoryAverages.tactical.toFixed(1)}
                    </span>
                </div>
                <div class="flex space-x-1">
                    ${generateProgressBars(categories.tactical, 'green')}
                </div>
            </div>`;

        // Mental attributes
        newContent += `
            <div class="bg-purple-50 rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-purple-700">
                        <i class="fas fa-brain mr-1"></i>Mental
                    </span>
                    <span class="text-sm font-bold text-purple-800">
                        ${categoryAverages.mental.toFixed(1)}
                    </span>
                </div>
                <div class="flex space-x-1">
                    ${generateProgressBars(categories.mental, 'purple')}
                </div>
            </div>`;

        // Goalkeeping attributes (if applicable)
        if (categories.goalkeeping) {
            newContent += `
                <div class="bg-yellow-50 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-yellow-700">
                            <i class="fas fa-hand-paper mr-1"></i>Goalkeeping
                        </span>
                        <span class="text-sm font-bold text-yellow-800">
                            ${categoryAverages.goalkeeping.toFixed(1)}
                        </span>
                    </div>
                    <div class="flex space-x-1">
                        ${generateProgressBars(categories.goalkeeping, 'yellow')}
                    </div>
                </div>`;
        }

        // Notes (if any)
        if (attributes.notes) {
            newContent += `
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-sticky-note mr-1 text-gray-400"></i>
                        ${attributes.notes}
                    </p>
                </div>`;
        }

        attributesContainer.innerHTML = newContent;
    }

    // Update the button text if needed
    const editButton = playerCard.querySelector('button');
    if (editButton) {
        editButton.innerHTML = '<i class="fas fa-edit mr-2"></i>Edit Attributes';
    }
}

function closeAttributesModal() {
    const modal = document.getElementById('attributes-modal');
    if (modal) {
        modal.remove();
    }
}
</script>
{% endblock %}